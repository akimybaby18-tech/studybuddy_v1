<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>StudyBuddy</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Baloo+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>if(typeof pdfjsLib!=='undefined'){pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';}</script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<style>
:root{--bg:#e8e0f0;--surface:rgba(255,255,255,0.75);--surface2:rgba(255,255,255,0.55);--surface3:rgba(255,255,255,0.35);--border:rgba(180,160,220,0.35);--border2:rgba(160,140,200,0.45);--glass:rgba(255,255,255,0.6);--glass2:rgba(255,255,255,0.4);--purple:#8b5cf6;--purple-l:#a78bfa;--purple-d:#6d28d9;--purple-g:rgba(139,92,246,0.18);--pink:#ec4899;--pink-l:#f472b6;--pink-soft:rgba(236,72,153,0.12);--yellow:#fbbf24;--yellow-l:#fcd34d;--yellow-soft:rgba(251,191,36,0.15);--green:#10b981;--green-l:#34d399;--green-soft:rgba(16,185,129,0.12);--blue:#3b82f6;--blue-l:#60a5fa;--blue-soft:rgba(59,130,246,0.12);--orange:#f97316;--orange-l:#fb923c;--orange-soft:rgba(249,115,22,0.12);--teal:#14b8a6;--teal-l:#2dd4bf;--teal-soft:rgba(20,184,166,0.12);--red:#ef4444;--red-soft:rgba(239,68,68,0.12);--text:#2d1b69;--text2:#6b5b95;--text3:#9b8ec4;--shadow:rgba(100,60,180,0.12);--shadow2:rgba(100,60,180,0.2);--r:20px;--r-sm:14px;--r-lg:28px;--r-xl:36px;--transition:0.35s cubic-bezier(0.4,0,0.2,1);--bounce:0.5s cubic-bezier(0.34,1.56,0.64,1);--smooth:cubic-bezier(0.22,1,0.36,1)}
[data-theme="dark"]{--bg:#0f0b1a;--surface:rgba(30,24,55,0.85);--surface2:rgba(40,32,70,0.75);--surface3:rgba(50,40,85,0.6);--border:rgba(100,80,160,0.3);--border2:rgba(120,100,180,0.35);--glass:rgba(30,24,55,0.7);--glass2:rgba(40,32,70,0.5);--text:#f0e8ff;--text2:#b0a0d0;--text3:#6a5a90;--shadow:rgba(0,0,0,0.3);--shadow2:rgba(0,0,0,0.4)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;contain:layout style paint}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'Nunito',sans-serif;overflow:hidden;user-select:none;transition:background var(--transition),color var(--transition);contain:strict}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:4px}
.app-bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden;contain:strict}
.bg-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:0.3;will-change:transform;transform:translateZ(0);contain:strict}[data-theme="dark"] .bg-orb{opacity:0.15}
.bg-orb-1{width:300px;height:300px;background:#c084fc;top:-80px;right:-60px;animation:orbFloat 8s ease-in-out infinite}
.bg-orb-2{width:250px;height:250px;background:#818cf8;bottom:100px;left:-80px;animation:orbFloat 10s ease-in-out infinite reverse}
.bg-orb-3{width:200px;height:200px;background:#f0abfc;top:40%;left:50%;animation:orbFloat 12s ease-in-out infinite 2s}
.bg-orb-4{width:180px;height:180px;background:#67e8f9;bottom:200px;right:-40px;animation:orbFloat 9s ease-in-out infinite 1s}
@keyframes orbFloat{0%,100%{transform:translateY(0) scale(1) translateZ(0)}50%{transform:translateY(-30px) scale(1.1) translateZ(0)}}
#splash{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden;contain:strict}
.splash-bg{position:absolute;inset:0;background:linear-gradient(160deg,#1a0533 0%,#2d1b69 20%,#6d28d9 45%,#8b5cf6 60%,#a855f7 75%,#c084fc 90%,#e9d5ff 100%);background-size:600% 600%;animation:splashGradient 6s ease infinite}
@keyframes splashGradient{0%{background-position:0% 50%}25%{background-position:50% 100%}50%{background-position:100% 50%}75%{background-position:50% 0%}100%{background-position:0% 50%}}
.splash-stars{position:absolute;inset:0;overflow:hidden;pointer-events:none}.splash-star{position:absolute;border-radius:50%;background:#fff;animation:starTwinkle ease-in-out infinite;will-change:opacity,transform}
@keyframes starTwinkle{0%,100%{opacity:0.2;transform:scale(0.8)}50%{opacity:1;transform:scale(1.5)}}
.splash-particles{position:absolute;inset:0;overflow:hidden;pointer-events:none}.splash-particle{position:absolute;border-radius:50%;animation:splashParticleFloat linear infinite;will-change:transform,opacity}
@keyframes splashParticleFloat{0%{transform:translateY(100vh) rotate(0deg) scale(0);opacity:0}15%{opacity:1;transform:translateY(80vh) rotate(90deg) scale(1)}85%{opacity:0.8;transform:translateY(10vh) rotate(630deg) scale(0.6)}100%{transform:translateY(-10vh) rotate(720deg) scale(0);opacity:0}}
.splash-aurora{position:absolute;inset:0;overflow:hidden;pointer-events:none}.aurora-band{position:absolute;width:200%;height:40%;left:-50%;border-radius:50%;filter:blur(60px);mix-blend-mode:screen;animation:auroraDrift linear infinite;will-change:transform}
.aurora-band-1{top:10%;background:radial-gradient(ellipse,rgba(139,92,246,0.3),transparent 70%);animation-duration:8s}
.aurora-band-2{top:30%;background:radial-gradient(ellipse,rgba(236,72,153,0.2),transparent 70%);animation-duration:12s;animation-delay:-3s}
.aurora-band-3{top:50%;background:radial-gradient(ellipse,rgba(96,165,250,0.2),transparent 70%);animation-duration:10s;animation-delay:-6s}
@keyframes auroraDrift{0%{transform:translateX(-30%) rotate(-5deg)}50%{transform:translateX(30%) rotate(5deg)}100%{transform:translateX(-30%) rotate(-5deg)}}
.splash-rings{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}.splash-ring{position:absolute;border-radius:50%;border:1px solid rgba(255,255,255,0.08);animation:ringPulse 4s ease-out infinite;will-change:transform,opacity}
.splash-ring:nth-child(1){width:120px;height:120px}.splash-ring:nth-child(2){width:200px;height:200px;animation-delay:0.6s}.splash-ring:nth-child(3){width:280px;height:280px;animation-delay:1.2s}.splash-ring:nth-child(4){width:360px;height:360px;animation-delay:1.8s}.splash-ring:nth-child(5){width:440px;height:440px;animation-delay:2.4s}
@keyframes ringPulse{0%{transform:scale(0.5);opacity:0.5;border-color:rgba(255,255,255,0.15)}100%{transform:scale(2.5);opacity:0;border-color:transparent}}
.splash-logo-wrap{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;opacity:0;transform:scale(0.2) translateY(40px);animation:splashLogoEntry 1.2s cubic-bezier(0.34,1.56,0.64,1) 0.8s forwards;will-change:transform,opacity}
@keyframes splashLogoEntry{0%{opacity:0;transform:scale(0.2) translateY(40px) rotate(-15deg)}50%{opacity:1;transform:scale(1.1) translateY(-8px) rotate(3deg)}70%{transform:scale(0.95) translateY(2px) rotate(-1deg)}100%{opacity:1;transform:scale(1) translateY(0) rotate(0)}}
.logo-mark{position:relative;width:120px;height:120px;margin-bottom:20px;will-change:transform}.logo-book{width:80px;height:65px;position:absolute;bottom:18px;left:50%;transform:translateX(-50%);border-radius:6px 16px 16px 6px;background:linear-gradient(135deg,#8b5cf6,#a855f7);box-shadow:0 8px 30px rgba(139,92,246,0.5);animation:bookGlow 2s ease-in-out infinite alternate;will-change:box-shadow}
@keyframes bookGlow{0%{box-shadow:0 8px 30px rgba(139,92,246,0.4)}100%{box-shadow:0 12px 40px rgba(139,92,246,0.7),0 0 60px rgba(139,92,246,0.2)}}
.logo-book::before{content:'';position:absolute;left:0;top:0;bottom:0;width:10px;border-radius:6px 0 0 6px;background:linear-gradient(180deg,#6d28d9,#5b21b6)}.logo-book::after{content:'';position:absolute;right:8px;top:8px;bottom:8px;left:18px;border-radius:3px;background:rgba(255,255,255,0.2);border-top:2px solid rgba(255,255,255,0.3);border-bottom:2px solid rgba(255,255,255,0.3)}
.logo-sparkle{position:absolute;opacity:0;will-change:transform,opacity}.splash-logo-wrap .logo-sparkle{animation:sparkleEntry 0.5s ease forwards,sparkleFloat 2s ease-in-out 2s infinite}
.logo-sparkle-1{top:0;right:10px;font-size:20px;animation-delay:1.5s,2s}.logo-sparkle-2{top:8px;left:5px;font-size:14px;animation-delay:1.7s,2s}.logo-sparkle-3{top:2px;right:35px;font-size:16px;animation-delay:1.9s,2s}
@keyframes sparkleEntry{0%{opacity:0;transform:scale(0) rotate(-180deg)}100%{opacity:1;transform:scale(1) rotate(0deg)}}
@keyframes sparkleFloat{0%,100%{transform:translateY(0) scale(1);opacity:0.8}50%{transform:translateY(-6px) scale(1.2);opacity:1}}
.logo-brain{position:absolute;top:5px;left:50%;transform:translateX(-50%);font-size:36px;opacity:0;animation:brainEntry 0.6s cubic-bezier(0.34,1.56,0.64,1) 1.1s forwards,brainBounce 2s ease-in-out 2.1s infinite;will-change:transform}
@keyframes brainEntry{0%{opacity:0;transform:translateX(-50%) translateY(-20px) scale(0.5)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}
@keyframes brainBounce{0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(-5px)}}
.logo-ring-outer{position:absolute;inset:-8px;border-radius:50%;border:2px solid transparent;border-top-color:rgba(251,191,36,0.5);border-right-color:rgba(236,72,153,0.4);opacity:0;animation:logoRingEntry 0.5s ease 1.2s forwards,logoRingSpin 4s linear 1.7s infinite;will-change:transform}
.logo-ring-inner{position:absolute;inset:-3px;border-radius:50%;border:1.5px solid transparent;border-bottom-color:rgba(96,165,250,0.4);border-left-color:rgba(16,185,129,0.3);opacity:0;animation:logoRingEntry 0.5s ease 1.4s forwards,logoRingSpinRev 3s linear 1.9s infinite;will-change:transform}
@keyframes logoRingEntry{0%{opacity:0;transform:scale(0.5)}100%{opacity:1;transform:scale(1)}}
@keyframes logoRingSpin{to{transform:rotate(360deg)}}@keyframes logoRingSpinRev{to{transform:rotate(-360deg)}}
.splash-title{font-family:'Baloo 2',sans-serif;font-size:40px;font-weight:800;color:#fff;margin-bottom:6px;letter-spacing:-0.02em;text-shadow:0 4px 30px rgba(139,92,246,0.5),0 0 60px rgba(236,72,153,0.3);opacity:0;animation:titleGlowIn 0.8s var(--smooth) 1.4s forwards;will-change:transform,opacity,filter}
@keyframes titleGlowIn{0%{opacity:0;transform:translateY(25px) scale(0.9);filter:blur(10px)}100%{opacity:1;transform:translateY(0) scale(1);filter:blur(0)}}
.splash-tagline{font-size:14px;color:rgba(255,255,255,0.75);text-align:center;line-height:1.6;max-width:260px;opacity:0;animation:titleGlowIn 0.7s var(--smooth) 1.6s forwards;will-change:transform,opacity}
.splash-loader{margin-top:40px;width:180px;height:5px;border-radius:5px;background:rgba(255,255,255,0.1);overflow:hidden;opacity:0;animation:titleGlowIn 0.5s var(--smooth) 1.8s forwards;position:relative;will-change:opacity}
.splash-loader-fill{height:100%;width:0%;border-radius:5px;background:linear-gradient(90deg,#fbbf24,#f472b6,#a78bfa,#60a5fa,#34d399);background-size:300% 100%;animation:loaderFill 2.5s cubic-bezier(0.4,0,0.2,1) 2s forwards,loaderShimmer 1.5s ease infinite;will-change:width}
@keyframes loaderFill{0%{width:0%}100%{width:100%}}@keyframes loaderShimmer{0%{background-position:300% 0}100%{background-position:-300% 0}}
.splash-loader-glow{position:absolute;top:-2px;bottom:-2px;width:40px;border-radius:5px;background:rgba(255,255,255,0.4);filter:blur(4px);animation:loaderGlow 2.5s ease 2s forwards;left:0;will-change:left}
@keyframes loaderGlow{0%{left:0%}100%{left:calc(100% - 40px)}}
.splash-version{position:absolute;bottom:40px;font-size:11px;font-weight:700;color:rgba(255,255,255,0.3);letter-spacing:0.15em;text-transform:uppercase;opacity:0;animation:titleGlowIn 0.5s var(--smooth) 2.2s forwards;will-change:opacity}
#splash.exit{animation:splashExit 1s cubic-bezier(0.4,0,0.2,1) forwards}#splash.exit .splash-logo-wrap{animation:splashLogoExit 0.6s var(--smooth) forwards}
@keyframes splashExit{0%{opacity:1}100%{opacity:0;pointer-events:none}}@keyframes splashLogoExit{0%{opacity:1;transform:scale(1)}100%{opacity:0;transform:scale(1.5);filter:blur(20px)}}
.particle{position:fixed;border-radius:50%;pointer-events:none;z-index:99998;will-change:transform,opacity;animation:particleFly 1s ease-out forwards;contain:strict}
@keyframes particleFly{0%{opacity:1;transform:translate(0,0) scale(1)}100%{opacity:0;transform:translate(var(--tx),var(--ty)) scale(0)}}
.screen{display:none;flex-direction:column;flex:1;overflow:hidden;position:relative;z-index:1;will-change:transform,opacity;contain:layout}.screen.active{display:flex}
.screen.entering{animation:screenEnter 0.5s var(--smooth) forwards}.screen.exiting{animation:screenExit 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes screenEnter{0%{opacity:0;transform:translateY(24px) scale(0.97)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes screenExit{0%{opacity:1;transform:translateY(0) scale(1)}100%{opacity:0;transform:translateY(-16px) scale(0.98)}}
.screen.entering-left{animation:enterLeft 0.5s var(--smooth) forwards}.screen.entering-right{animation:enterRight 0.5s var(--smooth) forwards}
.screen.exiting-left{animation:exitLeft 0.35s var(--smooth) forwards;pointer-events:none}.screen.exiting-right{animation:exitRight 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes enterLeft{0%{opacity:0;transform:translateX(50px) scale(0.98)}100%{opacity:1;transform:translateX(0) scale(1)}}
@keyframes enterRight{0%{opacity:0;transform:translateX(-50px) scale(0.98)}100%{opacity:1;transform:translateX(0) scale(1)}}
@keyframes exitLeft{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(-30px) scale(0.98)}}
@keyframes exitRight{0%{opacity:1;transform:translateX(0)}100%{opacity:0;transform:translateX(30px) scale(0.98)}}
.screen.entering-up{animation:enterUp 0.5s var(--smooth) forwards}.screen.exiting-down{animation:exitDown 0.35s var(--smooth) forwards;pointer-events:none}
@keyframes enterUp{0%{opacity:0;transform:translateY(60px) scale(0.96)}100%{opacity:1;transform:translateY(0) scale(1)}}
@keyframes exitDown{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(40px) scale(0.97)}}
#app{height:100dvh;display:flex;flex-direction:column;max-width:480px;margin:0 auto;position:relative;contain:layout}
.scroll-body{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;contain:content}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:14px 18px 12px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:10;transition:background var(--transition);contain:layout}
.topbar-logo-wrap{display:flex;align-items:center;gap:8px}.topbar-logo-icon{width:32px;height:32px;border-radius:10px;background:linear-gradient(135deg,var(--purple),var(--pink));display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 2px 8px rgba(139,92,246,0.3);flex-shrink:0}
.topbar-logo{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.topbar-title{font-size:17px;font-weight:800;color:var(--text)}
.back-btn{width:38px;height:38px;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);color:var(--text2);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.25s var(--smooth);flex-shrink:0;box-shadow:0 2px 8px var(--shadow);contain:layout}.back-btn:hover{background:var(--surface2);color:var(--text);transform:scale(1.05)}.back-btn:active{transform:scale(0.95)}
.bottom-nav{display:flex;border-top:1px solid var(--border);flex-shrink:0;padding:6px 8px max(10px,env(safe-area-inset-bottom));background:var(--glass);backdrop-filter:blur(20px) saturate(1.8);transition:background var(--transition);contain:layout}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;padding:8px 4px;cursor:pointer;transition:all 0.4s var(--smooth);border-radius:var(--r);margin:2px 3px;position:relative;contain:layout}
.nav-icon{font-size:22px;transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);will-change:transform}.nav-label{font-size:10px;font-weight:800;letter-spacing:0.03em;color:var(--text3);transition:all 0.35s var(--smooth)}
.nav-item.active{background:var(--purple-g)}.nav-item.active .nav-icon{transform:scale(1.2) translateY(-2px)}.nav-item.active .nav-label{color:var(--purple);font-weight:900}
.nav-item.active::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:20px;height:3px;border-radius:3px;background:linear-gradient(90deg,var(--purple),var(--pink));animation:navDotPop 0.4s cubic-bezier(0.34,1.56,0.64,1) forwards}
@keyframes navDotPop{0%{width:0;opacity:0}100%{width:20px;opacity:1}}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:14px 24px;border-radius:var(--r);font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;cursor:pointer;border:none;transition:all 0.3s var(--smooth);white-space:nowrap;will-change:transform;contain:layout}
.btn-primary{background:linear-gradient(135deg,var(--purple),#a855f7,var(--pink));color:#fff;box-shadow:0 6px 24px rgba(139,92,246,0.35)}.btn-primary:hover{transform:translateY(-3px);box-shadow:0 10px 36px rgba(139,92,246,0.45)}.btn-primary:active{transform:translateY(1px) scale(0.98)}
.btn-secondary{background:var(--surface);border:1.5px solid var(--border2);color:var(--text);font-weight:700;box-shadow:0 2px 10px var(--shadow);backdrop-filter:blur(10px)}.btn-secondary:hover{background:var(--surface2);transform:translateY(-2px)}.btn-secondary:active{transform:translateY(0) scale(0.98)}
.btn-ghost{background:transparent;color:var(--text2);padding:10px 16px}.btn-ghost:hover{color:var(--text);background:var(--surface3)}
.btn-danger{background:var(--red-soft);border:1.5px solid rgba(239,68,68,0.3);color:var(--red)}
.btn-full{width:100%}.btn-sm{padding:9px 16px;font-size:13px}.btn-xs{padding:6px 12px;font-size:11px}
.form-input{width:100%;padding:14px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;font-weight:600;outline:none;transition:all 0.3s var(--smooth);box-shadow:0 2px 8px var(--shadow);backdrop-filter:blur(10px)}.form-input:focus{border-color:var(--purple);box-shadow:0 0 0 4px rgba(139,92,246,0.12)}.form-input::placeholder{color:var(--text3)}
textarea.form-input{resize:none;line-height:1.7}
select.form-input{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239b8ec4' stroke-width='3' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 16px center}
.card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;backdrop-filter:blur(16px) saturate(1.5);box-shadow:0 4px 20px var(--shadow);contain:layout}
.pill{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;background:var(--surface2);border:1px solid var(--border);color:var(--text2)}
.section-label{font-size:11px;font-weight:900;letter-spacing:0.1em;text-transform:uppercase;color:var(--text3);margin-bottom:12px}
.toast{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--surface);border:1.5px solid var(--border2);border-radius:var(--r);padding:14px 22px;font-size:14px;font-weight:700;z-index:9990;opacity:0;transition:all 0.45s var(--smooth);white-space:nowrap;pointer-events:none;max-width:90vw;text-align:center;box-shadow:0 8px 32px var(--shadow2);backdrop-filter:blur(20px);color:var(--text);will-change:transform,opacity}.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.ach-popup{position:fixed;top:20px;left:50%;transform:translateX(-50%) translateY(-120px);background:var(--surface);border:2px solid var(--yellow);border-radius:var(--r-lg);padding:16px 22px;z-index:9991;opacity:0;transition:all 0.6s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;gap:14px;max-width:340px;box-shadow:0 8px 40px rgba(251,191,36,0.25);backdrop-filter:blur(20px);will-change:transform,opacity}.ach-popup.show{opacity:1;transform:translateX(-50%) translateY(0)}
.ach-pop-icon{font-size:36px}.ach-pop-text h4{font-size:10px;font-weight:900;color:var(--yellow);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:3px}.ach-pop-text p{font-size:14px;font-weight:800;color:var(--text)}
.theme-toggle{width:44px;height:24px;border-radius:12px;background:var(--surface2);border:1.5px solid var(--border);cursor:pointer;position:relative;transition:all 0.4s var(--smooth);flex-shrink:0;contain:layout}
.theme-toggle-knob{width:18px;height:18px;border-radius:50%;background:linear-gradient(135deg,var(--yellow),var(--orange));position:absolute;top:2px;left:2px;transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);display:flex;align-items:center;justify-content:center;font-size:10px;will-change:transform}[data-theme="dark"] .theme-toggle-knob{left:22px;background:linear-gradient(135deg,#6366f1,#8b5cf6)}
.modal-overlay{position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.4);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:all 0.4s var(--smooth);contain:strict}.modal-overlay.show{opacity:1;pointer-events:auto}
.modal-content{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-xl);padding:24px;width:calc(100% - 40px);max-width:400px;backdrop-filter:blur(20px);box-shadow:0 20px 60px var(--shadow2);transform:translateY(40px) scale(0.92);transition:all 0.5s cubic-bezier(0.34,1.56,0.64,1);max-height:90vh;overflow-y:auto;position:relative;will-change:transform}.modal-overlay.show .modal-content{transform:translateY(0) scale(1)}
.modal-title{font-family:'Baloo 2',sans-serif;font-size:22px;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:8px;color:var(--text)}.modal-subtitle{font-size:12px;color:var(--text2);margin-bottom:18px}
.modal-close{position:absolute;top:16px;right:16px;width:30px;height:30px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:14px;color:var(--text3);transition:all 0.25s var(--smooth)}.modal-close:hover{background:var(--red-soft);color:var(--red)}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.setup-body{padding:24px 20px}.setup-h{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:700;margin-bottom:6px}.setup-sub{font-size:14px;color:var(--text2);margin-bottom:24px}
.form-group{margin-bottom:20px}.form-label{font-size:12px;font-weight:900;color:var(--text2);margin-bottom:8px;display:block;letter-spacing:0.06em;text-transform:uppercase}
.avatar-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.av-opt{aspect-ratio:1;background:var(--surface);border:2.5px solid var(--border);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);position:relative;overflow:hidden;contain:layout}.av-opt:active{transform:scale(0.95)}.av-opt.sel{border-color:var(--purple);background:var(--purple-g);transform:scale(1.1)}.av-opt.sel::after{content:'\2713';position:absolute;bottom:2px;right:4px;font-size:12px;color:var(--purple);font-weight:900}
.pfp-upload-opt{aspect-ratio:1;background:var(--surface);border:2.5px dashed var(--border2);border-radius:var(--r);display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);position:relative;overflow:hidden;flex-direction:column;gap:2px;contain:layout}.pfp-upload-opt:hover{border-color:var(--purple);background:var(--purple-g)}.pfp-upload-opt:active{transform:scale(0.95)}.pfp-upload-opt.sel{border-color:var(--purple);border-style:solid;background:var(--purple-g);transform:scale(1.1)}.pfp-upload-opt.sel::after{content:'\2713';position:absolute;bottom:2px;right:4px;font-size:12px;color:var(--purple);font-weight:900}
.pfp-upload-opt .pfp-label{font-size:8px;font-weight:800;color:var(--text3);text-transform:uppercase}.pfp-preview{width:100%;height:100%;object-fit:cover;border-radius:calc(var(--r) - 3px)}
.home-pfp{width:36px;height:36px;border-radius:12px;object-fit:cover;border:2px solid var(--border);cursor:pointer;transition:all 0.3s var(--smooth)}.home-pfp:hover{border-color:var(--purple);transform:scale(1.1)}
.grade-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.grade-opt{padding:11px 6px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);text-align:center;font-size:12px;font-weight:700;cursor:pointer;transition:all 0.3s var(--smooth);color:var(--text2);contain:layout}.grade-opt:active{transform:scale(0.95)}.grade-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.quiz-header{padding:14px 18px 12px;flex-shrink:0}.quiz-prog-bar{height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;margin-bottom:8px}.quiz-prog-fill{height:100%;background:linear-gradient(90deg,var(--purple),var(--pink),var(--yellow));border-radius:5px;transition:width 0.6s var(--smooth);will-change:width}
.quiz-meta{display:flex;justify-content:space-between;font-size:12px;color:var(--text3);font-weight:700}.quiz-body{flex:1;overflow-y:auto;padding:20px;contain:content}
.quiz-scenario{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:20px}.quiz-scenario .scenario-label{font-size:10px;font-weight:900;color:var(--purple);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px}
.quiz-qtext{font-family:'Baloo 2',sans-serif;font-size:20px;font-weight:700;line-height:1.35;margin-bottom:18px}.quiz-opts{display:flex;flex-direction:column;gap:9px}
.quiz-opt{padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;font-size:13px;font-weight:700;color:var(--text2);contain:layout}.quiz-opt:hover{border-color:var(--border2);transform:translateX(4px)}.quiz-opt:active{transform:translateX(2px) scale(0.99)}.quiz-opt.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple);transform:translateX(6px)}
.quiz-dot{width:22px;height:22px;border-radius:50%;border:2px solid var(--border2);flex-shrink:0;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;font-size:11px}.quiz-opt.sel .quiz-dot{border-color:var(--purple);background:var(--purple);color:#fff}
.quiz-footer{padding:10px 18px 14px;flex-shrink:0;border-top:1px solid var(--border);display:flex;gap:10px;background:var(--glass);backdrop-filter:blur(16px)}
.results-hero{padding:28px 20px 0;text-align:center}.results-bigicon{font-size:64px;margin-bottom:12px;display:block;animation:pop 0.6s cubic-bezier(0.34,1.56,0.64,1) both}.results-h{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;margin-bottom:6px}.results-sub{font-size:13px;color:var(--text2);margin-bottom:20px}.results-body{padding:0 18px 20px}
.result-card{padding:16px;border-radius:var(--r);margin-bottom:10px;display:flex;align-items:center;gap:12px;border:2px solid;cursor:pointer;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(10px);contain:layout}.result-card:hover{transform:translateX(6px)}
.result-rank{font-family:'Baloo 2',sans-serif;font-size:30px;font-weight:800;flex-shrink:0;width:42px;text-align:center}.result-info h4{font-size:14px;font-weight:800;margin-bottom:3px}.result-info p{font-size:11px;opacity:0.7}
.result-pct-wrap{margin-left:auto;text-align:right;flex-shrink:0}.result-pct{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800;line-height:1}.result-pct-label{font-size:9px;font-weight:700;opacity:0.6;text-transform:uppercase}
.result-bar-bg{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(0,0,0,0.1)}.result-bar-fill{height:100%;border-radius:0 4px 0 0;transition:width 1.2s var(--smooth);will-change:width}
@keyframes pop{from{transform:scale(0) rotate(-20deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.home-scroll{padding:14px 14px 16px}.greeting{margin-bottom:16px}.greeting-hi{font-size:13px;color:var(--text2);font-weight:600}.greeting-name{font-family:'Baloo 2',sans-serif;font-size:26px;font-weight:800}
.pet-lv-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:14px;display:flex;gap:14px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow);contain:layout}.pet-lv-icon{font-size:34px}.pet-lv-info{flex:1}.pet-lv-lbl{font-size:12px;color:var(--text2);font-weight:700;margin-bottom:6px;display:flex;justify-content:space-between}.pet-lv-track{height:12px;background:var(--surface3);border-radius:6px;overflow:hidden}.pet-lv-fill{height:100%;background:linear-gradient(90deg,#deb887,#f97316,#fbbf24);border-radius:6px;transition:width 1s var(--smooth);will-change:width}
.cookie-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 12px;border-radius:20px;background:linear-gradient(135deg,var(--orange-soft),var(--yellow-soft));border:1.5px solid rgba(249,115,22,0.3);font-size:13px;font-weight:800;color:var(--orange);cursor:pointer;transition:all 0.3s var(--smooth);flex-shrink:0;contain:layout}.cookie-badge:hover{transform:scale(1.05)}.cookie-badge:active{transform:scale(0.95)}
.cookie-badge .cookie-icon{font-size:16px}.cookie-badge .cookie-count{font-family:'Baloo 2',sans-serif}
@keyframes cookiePop{0%{transform:scale(1)}50%{transform:scale(1.3)}100%{transform:scale(1)}}
.cookie-pop{animation:cookiePop 0.3s ease}
.streak-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:14px 16px;margin-bottom:14px;display:flex;gap:12px;align-items:center;backdrop-filter:blur(16px);box-shadow:0 4px 20px var(--shadow);contain:layout}.streak-days{display:flex;gap:5px;flex:1}.sday{flex:1;aspect-ratio:1;border-radius:10px;background:var(--surface2);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;font-size:9px;font-weight:800;color:var(--text3);contain:layout}.sday.done{background:var(--purple-g);color:var(--purple)}.sday.today{background:linear-gradient(135deg,var(--purple),var(--pink));color:#fff}.sday-dot{width:5px;height:5px;border-radius:50%;background:currentColor;opacity:0.7}.streak-stat{text-align:center}.streak-num{font-family:'Baloo 2',sans-serif;font-size:34px;font-weight:800;color:var(--orange);line-height:1}.streak-lbl{font-size:9px;font-weight:800;color:var(--text3);text-transform:uppercase}
.tech-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:16px}.tc{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;cursor:pointer;transition:all 0.35s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.tc:hover{transform:translateY(-5px) scale(1.02)}.tc:active{transform:translateY(-2px) scale(0.99)}.tc-icon{font-size:32px;margin-bottom:8px;display:block}.tc-name{font-size:13px;font-weight:800;margin-bottom:3px}.tc-desc{font-size:11px;color:var(--text2);line-height:1.4}.tc-badge{position:absolute;top:10px;right:10px;font-size:9px;font-weight:900;padding:3px 8px;border-radius:8px;text-transform:uppercase}.tc-best{background:var(--yellow-soft);color:var(--orange);border:1px solid rgba(251,191,36,0.4)}.tc-match{background:var(--surface3);color:var(--text3);border:1px solid var(--border)}
.tip-card{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.2);border-radius:var(--r-lg);padding:16px 18px;margin-bottom:16px}.tip-card p{font-size:13px;color:var(--text2);line-height:1.7}
.tech-list-item{display:flex;align-items:center;gap:14px;padding:16px 18px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);cursor:pointer;transition:all 0.3s var(--smooth);margin-bottom:10px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.tech-list-item:hover{border-color:var(--purple-l);transform:translateX(6px)}.tli-icon{font-size:34px;flex-shrink:0}.tli-info{flex:1}.tli-name{font-size:15px;font-weight:800;margin-bottom:3px}.tli-desc{font-size:12px;color:var(--text2)}.tli-match{margin-top:6px;display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:800}
.fc-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);contain:layout}.fc-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent}.fc-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.fc-section{display:none;padding:16px;flex:1;overflow-y:auto;contain:content}.fc-section.active{display:block;animation:sectionFade 0.4s var(--smooth) forwards}
@keyframes sectionFade{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}
.deck-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:12px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.deck-card:hover{border-color:var(--purple-l);transform:translateX(4px)}.deck-dot{width:14px;height:14px;border-radius:6px;flex-shrink:0}.deck-info h4{font-size:15px;font-weight:800;margin-bottom:2px}.deck-info p{font-size:11px;color:var(--text2)}.deck-count{margin-left:auto;font-size:13px;font-weight:800;color:var(--text3)}
.create-deck-form{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.create-deck-form h4{font-size:14px;font-weight:800;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.color-picker{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}.color-swatch{width:30px;height:30px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);contain:layout}.color-swatch.sel{border-color:#fff;transform:scale(1.25)}
.fc-scene{perspective:1000px;height:220px;cursor:pointer;margin-bottom:16px;contain:layout}.fc-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;transition:transform 0.7s var(--smooth);will-change:transform}.fc-inner.flipped{transform:rotateY(180deg)}
.fc-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;background:var(--surface);border:2px solid var(--border);border-radius:var(--r-lg);display:flex;align-items:center;justify-content:center;padding:20px;flex-direction:column;gap:8px;backdrop-filter:blur(16px);box-shadow:0 8px 32px var(--shadow);will-change:transform}.fc-back-face{transform:rotateY(180deg);background:linear-gradient(135deg,var(--surface),var(--surface2))}.fc-face-label{font-size:10px;font-weight:900;color:var(--text3);letter-spacing:0.12em;text-transform:uppercase}.fc-face-text{font-size:18px;font-weight:800;text-align:center;line-height:1.4}.fc-face-hint{font-size:11px;color:var(--text3);margin-top:4px}
.fc-rate-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}.fc-rate{padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;cursor:pointer;border:1.5px solid;transition:all 0.25s var(--smooth);text-align:center;contain:layout}.fc-again{background:var(--red-soft);border-color:rgba(239,68,68,0.3);color:var(--red)}.fc-hard{background:var(--orange-soft);border-color:rgba(249,115,22,0.3);color:var(--orange)}.fc-good{background:var(--green-soft);border-color:rgba(16,185,129,0.3);color:var(--green)}.fc-rate:hover{transform:translateY(-3px)}.fc-rate:active{transform:scale(0.97)}
.ai-gen-box{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:1.5px solid rgba(139,92,246,0.25);border-radius:var(--r-lg);padding:18px;margin-bottom:14px}.ai-gen-box h4{font-size:14px;font-weight:800;margin-bottom:4px;display:flex;align-items:center;gap:6px}.ai-gen-box p{font-size:12px;color:var(--text2);margin-bottom:12px;line-height:1.5}
.upload-area{border:2px dashed var(--border2);border-radius:var(--r);padding:22px;text-align:center;cursor:pointer;transition:all 0.3s var(--smooth);background:var(--surface);margin-bottom:10px;contain:layout}.upload-area:hover,.upload-area.drag{border-color:var(--purple);background:var(--purple-g)}.upload-icon{font-size:36px;margin-bottom:8px;display:block}.upload-text{font-size:13px;font-weight:700;color:var(--text2);margin-bottom:4px}.upload-hint{font-size:11px;color:var(--text3)}
.upload-status{padding:12px 16px;border-radius:var(--r-sm);margin-bottom:10px;font-size:12px;font-weight:700;display:flex;align-items:center;gap:8px}.upload-loading{background:var(--blue-soft);color:var(--blue);border:1px solid rgba(59,130,246,0.3)}.upload-success{background:var(--green-soft);color:var(--green);border:1px solid rgba(16,185,129,0.3)}
.spinner{width:20px;height:20px;border:2.5px solid var(--border);border-top-color:var(--purple);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;will-change:transform}@keyframes spin{to{transform:rotate(360deg)}}
.wb-topbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);flex-wrap:wrap;contain:layout}.wb-colors{display:flex;gap:6px;align-items:center}.wb-color{width:24px;height:24px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);flex-shrink:0;contain:layout}.wb-color.sel{border-color:#fff;transform:scale(1.3)}.wb-sizes{display:flex;gap:4px}.wb-sz{width:32px;height:32px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:11px;font-weight:800}.wb-sz.sel{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}.wb-tools{display:flex;gap:4px}.wb-tool{padding:7px 12px;border-radius:10px;background:var(--surface);border:1.5px solid var(--border);cursor:pointer;font-size:12px;font-weight:700;color:var(--text2);transition:all 0.25s var(--smooth)}.wb-tool.sel{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}
.wb-canvas-wrap{flex:1;position:relative;overflow:hidden;contain:strict}#wbCanvas{display:block;width:100%;height:100%;touch-action:none}
.diag-toolbar{display:flex;align-items:center;gap:8px;padding:10px 14px;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);overflow-x:auto;contain:layout}.diag-toolbar::-webkit-scrollbar{display:none}.diag-color{width:22px;height:22px;border-radius:50%;cursor:pointer;border:2.5px solid transparent;flex-shrink:0;transition:all 0.35s cubic-bezier(0.34,1.56,0.64,1);contain:layout}.diag-color.sel{border-color:#fff;transform:scale(1.3)}.diag-add-input{flex:1;min-width:100px;padding:8px 14px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-sm);color:var(--text);font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;outline:none}.diag-add-input:focus{border-color:var(--purple)}
.diag-canvas-wrap{flex:1;position:relative;overflow:hidden;background:var(--surface3);contain:strict}#diagCanvas{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}.diag-nodes-layer{position:absolute;inset:0}.diag-node{position:absolute;padding:10px 16px;border-radius:var(--r-sm);font-size:13px;font-weight:800;cursor:move;border:2px solid;white-space:normal;text-align:center;touch-action:none;box-shadow:0 4px 16px var(--shadow);max-width:200px;word-break:break-word;backdrop-filter:blur(10px);will-change:transform;contain:layout}.diag-node.root{border-width:3px;font-size:14px}.diag-node-del{position:absolute;top:-8px;right:-8px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;opacity:0;transition:opacity 0.2s}.diag-node:hover .diag-node-del{opacity:1}
.diag-bottom-bar{padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);contain:layout}
.sched-week{display:grid;grid-template-columns:repeat(7,1fr);gap:5px;margin-bottom:16px}.sched-day{aspect-ratio:0.9;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;contain:layout}.sched-dlbl{font-size:8px;font-weight:900;color:var(--text3);text-transform:uppercase}.sched-dnum{font-size:13px;font-weight:800;color:var(--text2)}.sched-day.has{border-color:var(--purple);background:var(--purple-g)}.sched-day.has .sched-dnum{color:var(--purple)}.sched-day.rest{border-color:var(--teal);background:var(--teal-soft)}.sched-day.rest .sched-dnum{color:var(--teal)}.sched-day.today{border-color:var(--orange);box-shadow:0 4px 16px rgba(249,115,22,0.2)}.sched-day.today .sched-dnum{color:var(--orange)}
.sess-item{display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);margin-bottom:8px;backdrop-filter:blur(16px);box-shadow:0 2px 10px var(--shadow);transition:all 0.25s var(--smooth);contain:layout}.sess-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0}.sess-info h4{font-size:14px;font-weight:800;margin-bottom:2px}.sess-info p{font-size:11px;color:var(--text2)}.sess-time{margin-left:auto;font-size:12px;font-weight:800;color:var(--text3);text-align:right}.sess-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;transition:all 0.2s}.sess-del:hover{color:var(--red)}
.timer-wrap{text-align:center;padding:20px 0}.timer-ring{width:170px;height:170px;border-radius:50%;background:var(--surface);border:4px solid var(--border);margin:0 auto 14px;display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:42px;font-weight:800;color:var(--purple);box-shadow:0 8px 40px var(--shadow);transition:all 0.4s var(--smooth);will-change:transform,box-shadow;contain:layout}.timer-ring.focus-mode{border-color:var(--purple);box-shadow:0 8px 48px rgba(139,92,246,0.3)}.timer-ring.break-mode{border-color:var(--green)}.timer-phase{font-size:14px;color:var(--text2);font-weight:700;margin-bottom:14px}
.ach-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}.ach-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px 14px;text-align:center;transition:all 0.3s var(--smooth);position:relative;overflow:hidden;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.ach-card.unlocked:hover{transform:translateY(-4px)}.ach-card.locked{opacity:0.35}.ach-icon{font-size:36px;display:block;margin-bottom:8px}.ach-name{font-size:13px;font-weight:800;margin-bottom:4px;line-height:1.3}.ach-desc{font-size:10px;color:var(--text2);line-height:1.4;margin-bottom:8px}.ach-rarity{font-size:9px;font-weight:900;padding:3px 10px;border-radius:12px;text-transform:uppercase;display:inline-block}.r-common{background:var(--green-soft);color:var(--green)}.r-rare{background:var(--blue-soft);color:var(--blue)}.r-epic{background:rgba(167,139,250,0.15);color:#8b5cf6}.r-legendary{background:var(--yellow-soft);color:var(--orange)}.ach-new{position:absolute;top:8px;right:8px;font-size:9px;font-weight:900;padding:2px 8px;border-radius:8px;background:var(--yellow);color:#000;text-transform:uppercase}
.tech-body{padding:14px;flex:1;overflow-y:auto;contain:content}.blurt-timer-big{font-family:'Baloo 2',sans-serif;font-size:52px;font-weight:800;color:var(--purple);text-align:center;margin:8px 0 12px}.phase-badge{display:inline-flex;align-items:center;gap:6px;padding:7px 16px;border-radius:20px;font-size:12px;font-weight:800;margin-bottom:12px}.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}.compare-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:12px;font-size:12px;line-height:1.6;color:var(--text2);min-height:90px;word-break:break-word}.compare-box h5{font-size:10px;font-weight:900;color:var(--text3);margin-bottom:8px;text-transform:uppercase}
.feynman-steps{display:flex;gap:0;border-bottom:1px solid var(--border);margin-bottom:16px;background:var(--glass);contain:layout}.feynman-step{flex:1;padding:10px 6px;text-align:center;font-size:10px;font-weight:800;color:var(--text3);border-bottom:3px solid transparent;cursor:pointer;transition:all 0.35s var(--smooth);text-transform:uppercase}.feynman-step.active{color:var(--purple);border-bottom-color:var(--purple)}
.cornell-grid{display:grid;grid-template-columns:1fr 2fr;gap:10px;margin-bottom:10px}.cornell-lbl{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;margin-bottom:4px}
.rrr-btns{display:flex;gap:8px;margin-bottom:14px}.rrr-btn{flex:1;padding:12px 6px;border-radius:var(--r-sm);font-size:12px;font-weight:800;text-align:center;border:1.5px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text2);transition:all 0.3s var(--smooth)}.rrr-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}
.welcome-content{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100%;padding:36px 24px;text-align:center}.welcome-sub{font-size:15px;color:var(--text2);margin-bottom:28px;line-height:1.6;animation:fadeUp 0.7s var(--smooth) 0.1s both}.welcome-features{display:flex;flex-direction:column;gap:10px;width:100%;margin-bottom:28px}.wf{display:flex;align-items:center;gap:14px;padding:14px 16px;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);text-align:left;transition:all 0.3s var(--smooth);backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.wf:hover{border-color:var(--purple-l);transform:translateX(4px)}.wf-icon{font-size:28px;flex-shrink:0}.wf-text h4{font-size:14px;font-weight:800;margin-bottom:1px;color:var(--text)}.wf-text p{font-size:12px;color:var(--text2)}
.min-adjuster{display:flex;align-items:center;justify-content:center;gap:8px;margin:6px 0;flex-wrap:wrap}.min-adj-btn{padding:8px 14px;border-radius:var(--r-sm);background:var(--surface);border:1.5px solid var(--border);font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:var(--purple);cursor:pointer;transition:all 0.25s var(--smooth);contain:layout}.min-adj-btn:hover{background:var(--purple-g);border-color:var(--purple)}.min-adj-btn:active{transform:scale(0.93)}.min-adj-btn.minus{color:var(--red)}.min-adj-btn.minus:hover{background:var(--red-soft);border-color:var(--red)}.min-display{font-family:'Baloo 2',sans-serif;font-size:32px;font-weight:800;color:var(--purple);min-width:90px;text-align:center}.min-label{font-size:11px;color:var(--text3);font-weight:700;text-align:center;margin-top:-4px}.min-presets{display:flex;gap:6px;justify-content:center;margin:8px 0 14px;flex-wrap:wrap}.min-preset{padding:6px 14px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth);contain:layout}.min-preset:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}.min-preset.active{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}
.blurt-dur-presets{display:flex;gap:8px;justify-content:center;margin:8px 0 14px;flex-wrap:wrap}.blurt-dur-preset{padding:8px 18px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:12px;font-weight:800;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth);contain:layout}.blurt-dur-preset:hover{border-color:var(--pink);color:var(--pink);background:var(--pink-soft)}.blurt-dur-preset.active{border-color:var(--pink);color:var(--pink);background:var(--pink-soft)}
.test-q-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:18px;margin-bottom:14px;backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.test-q-card .test-q-num{font-size:10px;font-weight:900;color:var(--text3);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:6px}.test-q-card .test-q-text{font-family:'Baloo 2',sans-serif;font-size:17px;font-weight:700;line-height:1.4;margin-bottom:14px;color:var(--text)}.test-opt{padding:12px 14px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;gap:10px;font-size:13px;font-weight:700;color:var(--text2);margin-bottom:8px;contain:layout}.test-opt:hover{border-color:var(--border2);transform:translateX(3px)}.test-opt.selected{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}.test-opt.correct{border-color:var(--green);background:var(--green-soft);color:var(--green)}.test-opt.wrong{border-color:var(--red);background:var(--red-soft);color:var(--red)}.test-opt .opt-letter{width:24px;height:24px;border-radius:50%;border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:900;flex-shrink:0;transition:all 0.3s var(--smooth)}.test-opt.selected .opt-letter{border-color:var(--purple);background:var(--purple);color:#fff}.test-opt.correct .opt-letter{border-color:var(--green);background:var(--green);color:#fff}.test-opt.wrong .opt-letter{border-color:var(--red);background:var(--red);color:#fff}
.tf-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px}.tf-btn{padding:14px;border-radius:var(--r);font-size:15px;font-weight:800;cursor:pointer;border:2px solid var(--border);background:var(--surface);color:var(--text2);transition:all 0.3s var(--smooth);text-align:center;contain:layout}.tf-btn:hover{transform:translateY(-2px)}.tf-btn.selected{border-color:var(--purple);background:var(--purple-g);color:var(--purple)}.tf-btn.correct{border-color:var(--green);background:var(--green-soft);color:var(--green)}.tf-btn.wrong{border-color:var(--red);background:var(--red-soft);color:var(--red)}
.test-explanation{padding:10px 14px;border-radius:var(--r-sm);background:var(--blue-soft);border:1px solid rgba(59,130,246,0.3);font-size:12px;color:var(--blue);margin-top:8px;line-height:1.5;display:none}.test-explanation.show{display:block;animation:sectionFade 0.3s var(--smooth)}
.test-score-card{background:linear-gradient(135deg,var(--purple-g),var(--pink-soft));border:2px solid rgba(139,92,246,0.3);border-radius:var(--r-xl);padding:28px;text-align:center;margin-bottom:16px}.test-score-big{font-family:'Baloo 2',sans-serif;font-size:56px;font-weight:800;background:linear-gradient(135deg,var(--purple),var(--pink));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;line-height:1}.test-score-label{font-size:13px;color:var(--text2);font-weight:700;margin-top:4px}
.test-tabs{display:flex;gap:0;border-bottom:1px solid var(--border);flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);contain:layout}.test-tab{flex:1;padding:12px 8px;text-align:center;font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.35s var(--smooth);border-bottom:3px solid transparent}.test-tab.active{color:var(--purple);border-bottom-color:var(--purple)}
.test-section{display:none;padding:16px;flex:1;overflow-y:auto;contain:content}.test-section.active{display:block;animation:sectionFade 0.4s var(--smooth) forwards}
.saved-review-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r);padding:14px 16px;margin-bottom:10px;cursor:pointer;transition:all 0.3s var(--smooth);backdrop-filter:blur(16px);box-shadow:0 4px 16px var(--shadow);contain:layout}.saved-review-card:hover{border-color:var(--purple-l);transform:translateX(4px)}.saved-review-card .sr-header{display:flex;align-items:center;gap:10px;margin-bottom:6px}.saved-review-card .sr-icon{font-size:24px;flex-shrink:0}.saved-review-card .sr-title{font-size:14px;font-weight:800;color:var(--text)}.saved-review-card .sr-meta{font-size:11px;color:var(--text3);display:flex;gap:8px;flex-wrap:wrap}.saved-review-card .sr-badge{padding:2px 8px;border-radius:10px;font-size:10px;font-weight:800}.saved-review-card .sr-del{background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;transition:all 0.2s;margin-left:auto;flex-shrink:0}.saved-review-card .sr-del:hover{color:var(--red)}.sr-detail-content{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--r-lg);padding:16px;margin-bottom:12px;font-size:13px;line-height:1.7;color:var(--text2);white-space:pre-wrap;word-break:break-word;max-height:300px;overflow-y:auto}
.time-picker-wrap{display:flex;align-items:center;justify-content:center;gap:6px;margin:16px 0}.time-col{display:flex;flex-direction:column;align-items:center;gap:4px}.time-spin-btn{width:44px;height:34px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);color:var(--text2);font-size:18px;font-weight:800;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.25s var(--smooth);contain:layout}.time-spin-btn:hover{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}.time-spin-btn:active{transform:scale(0.9)}.time-display{width:56px;height:56px;border-radius:var(--r);background:var(--surface);border:2px solid var(--purple);display:flex;align-items:center;justify-content:center;font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--purple)}.time-sep{font-family:'Baloo 2',sans-serif;font-size:28px;font-weight:800;color:var(--text3);margin:0 2px;padding-top:20px}.time-ampm{display:flex;flex-direction:column;gap:4px;margin-left:8px}.ampm-btn{padding:6px 14px;border-radius:var(--r-sm);background:var(--surface2);border:1.5px solid var(--border);font-size:12px;font-weight:800;color:var(--text3);cursor:pointer;transition:all 0.3s var(--smooth);contain:layout}.ampm-btn.active{background:var(--purple-g);border-color:var(--purple);color:var(--purple)}.time-presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;justify-content:center}.time-preset{padding:6px 14px;border-radius:20px;background:var(--surface2);border:1.5px solid var(--border);font-size:11px;font-weight:700;color:var(--text2);cursor:pointer;transition:all 0.25s var(--smooth);contain:layout}.time-preset:hover{border-color:var(--purple);color:var(--purple);background:var(--purple-g)}
.capy-home-wrap{position:relative;margin-bottom:16px}.capy-container{background:linear-gradient(135deg,rgba(222,184,135,0.15),rgba(210,180,140,0.1));border:2px solid rgba(180,140,100,0.25);border-radius:var(--r-xl);padding:16px;position:relative;overflow:visible;backdrop-filter:blur(16px);box-shadow:0 6px 28px rgba(160,120,60,0.12);transition:all 0.4s var(--smooth);contain:layout}.capy-container:hover{box-shadow:0 8px 36px rgba(160,120,60,0.18)}
.capy-bubble{position:absolute;top:-12px;left:50%;transform:translateX(-50%) translateY(-100%);background:var(--surface);border:2px solid var(--border2);border-radius:var(--r);padding:10px 14px;font-size:12px;font-weight:700;color:var(--text);max-width:220px;text-align:center;line-height:1.45;box-shadow:0 4px 20px var(--shadow);z-index:5;opacity:0;pointer-events:none;transition:all 0.45s cubic-bezier(0.34,1.56,0.64,1);white-space:normal;word-break:break-word;will-change:transform,opacity}.capy-bubble.show{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-100%) scale(1)}.capy-bubble::after{content:'';position:absolute;bottom:-8px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:8px solid var(--surface)}.capy-bubble::before{content:'';position:absolute;bottom:-11px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:9px solid transparent;border-right:9px solid transparent;border-top:9px solid var(--border2)}.capy-bubble .bubble-icon{font-size:14px;margin-right:4px}
.capy-scene{display:flex;align-items:flex-end;justify-content:center;min-height:130px;cursor:pointer;position:relative;-webkit-tap-highlight-color:transparent;user-select:none;contain:layout}.capy-svg-wrap{position:relative;width:110px;height:110px;animation:capyIdle 3s ease-in-out infinite;transition:transform 0.3s var(--smooth);will-change:transform;contain:strict}.capy-svg-wrap:active{transform:scale(0.92)}.capy-svg-wrap.capy-bounce{animation:capyBounce 0.6s cubic-bezier(0.34,1.56,0.64,1)}.capy-svg-wrap.capy-happy{animation:capyHappy 0.8s ease}.capy-svg-wrap.capy-eat{animation:capyEat 1s ease}.capy-svg-wrap.capy-wiggle{animation:capyWiggle 0.5s ease}
@keyframes capyIdle{0%,100%{transform:translateY(0) rotate(0)}25%{transform:translateY(-3px) rotate(-0.5deg)}50%{transform:translateY(-5px) rotate(0.5deg)}75%{transform:translateY(-2px) rotate(-0.3deg)}}@keyframes capyBounce{0%{transform:translateY(0) scale(1)}30%{transform:translateY(-20px) scale(1.05,0.95)}50%{transform:translateY(0) scale(0.95,1.05)}70%{transform:translateY(-8px) scale(1.02)}100%{transform:translateY(0) scale(1)}}@keyframes capyHappy{0%{transform:rotate(0) scale(1)}15%{transform:rotate(-8deg) scale(1.08)}30%{transform:rotate(8deg) scale(1.08)}45%{transform:rotate(-5deg) scale(1.05)}60%{transform:rotate(5deg) scale(1.05)}75%{transform:rotate(-2deg) scale(1.02)}100%{transform:rotate(0) scale(1)}}@keyframes capyEat{0%{transform:scale(1)}20%{transform:scale(1.1,0.9)}40%{transform:scale(0.95,1.05)}60%{transform:scale(1.05,0.95)}80%{transform:scale(0.98,1.02)}100%{transform:scale(1)}}@keyframes capyWiggle{0%{transform:rotate(0)}20%{transform:rotate(-6deg)}40%{transform:rotate(6deg)}60%{transform:rotate(-4deg)}80%{transform:rotate(3deg)}100%{transform:rotate(0)}}.capy-shadow{width:90px;height:12px;background:radial-gradient(ellipse,rgba(0,0,0,0.12) 0%,transparent 70%);border-radius:50%;margin:0 auto;margin-top:-4px;animation:capyShadow 3s ease-in-out infinite;will-change:transform,opacity}@keyframes capyShadow{0%,100%{transform:scaleX(1);opacity:0.7}50%{transform:scaleX(0.85);opacity:0.5}}.capy-heart{position:absolute;font-size:16px;pointer-events:none;z-index:10;animation:heartFloat 1s ease-out forwards;opacity:0;will-change:transform,opacity}@keyframes heartFloat{0%{opacity:1;transform:translate(0,0) scale(0.5) rotate(0)}50%{opacity:1;transform:translate(var(--hx),-30px) scale(1.2) rotate(var(--hr))}100%{opacity:0;transform:translate(var(--hx),-60px) scale(0.3) rotate(var(--hr))}}.capy-info{display:flex;align-items:center;gap:10px;margin-top:10px}.capy-name-wrap{flex:1}.capy-name{font-family:'Baloo 2',sans-serif;font-size:16px;font-weight:800;color:var(--text);display:flex;align-items:center;gap:6px}.capy-level-badge{font-size:10px;font-weight:900;padding:2px 8px;border-radius:10px;background:linear-gradient(135deg,var(--yellow-soft),var(--orange-soft));color:var(--orange);border:1px solid rgba(249,115,22,0.3)}.capy-mood{font-size:11px;color:var(--text2);font-weight:700}.capy-stats{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}.capy-stat{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r-sm);padding:8px 10px}.capy-stat-label{font-size:9px;font-weight:900;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;display:flex;align-items:center;gap:4px}.capy-stat-bar{height:8px;background:var(--surface3);border-radius:4px;overflow:hidden}.capy-stat-fill{height:100%;border-radius:4px;transition:width 0.8s var(--smooth);will-change:width}.capy-hunger-fill{background:linear-gradient(90deg,#f97316,#fbbf24)}.capy-happy-fill{background:linear-gradient(90deg,#ec4899,#f472b6)}.capy-actions{display:flex;gap:8px;margin-top:10px}.capy-feed-btn{flex:1;padding:10px;border-radius:var(--r-sm);background:linear-gradient(135deg,var(--orange-soft),var(--yellow-soft));border:1.5px solid rgba(249,115,22,0.3);color:var(--orange);font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;gap:6px;contain:layout}.capy-feed-btn:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(249,115,22,0.15)}.capy-feed-btn:active{transform:scale(0.96)}.capy-feed-btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}.capy-feed-btn .feed-cost{font-size:10px;opacity:0.7}.capy-pet-btn{padding:10px 14px;border-radius:var(--r-sm);background:var(--pink-soft);border:1.5px solid rgba(236,72,153,0.3);color:var(--pink);font-family:'Nunito',sans-serif;font-size:12px;font-weight:800;cursor:pointer;transition:all 0.3s var(--smooth);display:flex;align-items:center;justify-content:center;gap:4px;contain:layout}.capy-pet-btn:hover{transform:translateY(-2px)}.capy-pet-btn:active{transform:scale(0.96)}.capy-zzz{position:absolute;font-size:14px;opacity:0;animation:zzzFloat 2s ease-in-out infinite;will-change:transform,opacity}@keyframes zzzFloat{0%{opacity:0;transform:translateY(0) scale(0.5)}30%{opacity:0.8;transform:translateY(-10px) scale(1)}70%{opacity:0.5;transform:translateY(-25px) scale(0.8)}100%{opacity:0;transform:translateY(-35px) scale(0.5)}}
</style>
</head>
<body>
<div class="app-bg"><div class="bg-orb bg-orb-1"></div><div class="bg-orb bg-orb-2"></div><div class="bg-orb bg-orb-3"></div><div class="bg-orb bg-orb-4"></div></div>
<div id="splash"><div class="splash-bg"></div><div class="splash-aurora"><div class="aurora-band aurora-band-1"></div><div class="aurora-band aurora-band-2"></div><div class="aurora-band aurora-band-3"></div></div><div class="splash-stars" id="splash-stars"></div><div class="splash-particles" id="splash-particles"></div><div class="splash-rings"><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div><div class="splash-ring"></div></div><div class="splash-logo-wrap"><div class="logo-mark"><div class="logo-ring-outer"></div><div class="logo-ring-inner"></div><div class="logo-brain"></div><div class="logo-book"></div><div class="logo-sparkle logo-sparkle-1"></div><div class="logo-sparkle logo-sparkle-2"></div><div class="logo-sparkle logo-sparkle-3"></div></div><div class="splash-title">StudyBuddy</div><div class="splash-tagline">Your personal study companion.<br>Learn smarter, not harder.</div></div><div class="splash-loader"><div class="splash-loader-fill"></div><div class="splash-loader-glow"></div></div><div class="splash-version">v2.1  Ready to learn</div></div>
<div id="app">
<div class="screen" id="screen-welcome"><div class="welcome-content"><div class="logo-mark" style="margin-bottom:10px;transform:scale(0.8);animation:fadeUp 0.5s ease both;"><div class="logo-ring-outer" style="animation:logoRingSpin 4s linear infinite;opacity:1;"></div><div class="logo-ring-inner" style="animation:logoRingSpinRev 3s linear infinite;opacity:1;"></div><div class="logo-brain" style="opacity:1;animation:brainBounce 2s ease-in-out infinite;"></div><div class="logo-book"></div><div class="logo-sparkle logo-sparkle-1" style="opacity:1;animation:sparkleFloat 2s ease-in-out infinite;"></div><div class="logo-sparkle logo-sparkle-2" style="opacity:1;animation:sparkleFloat 2s ease-in-out 0.5s infinite;"></div><div class="logo-sparkle logo-sparkle-3" style="opacity:1;animation:sparkleFloat 2s ease-in-out 1s infinite;"></div></div><div style="font-family:'Baloo 2',sans-serif;font-size:44px;font-weight:800;background:linear-gradient(135deg,var(--purple-d),var(--purple),var(--pink),var(--orange));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:6px;animation:fadeUp 0.7s var(--smooth) both;">StudyBuddy</div><div class="welcome-sub">Your personal study companion.<br>Learn smarter, not harder.</div><div class="welcome-features" style="animation:fadeUp 0.7s var(--smooth) 0.2s both;"><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>Scenario-Based Assessment</h4><p>Find your best study style</p></div></div><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>7 Study Workrooms</h4><p>Flashcards, Feynman, diagrams & more</p></div></div><div class="wf"><span class="wf-icon"></span><div class="wf-text"><h4>Achievements & Streaks</h4><p>Earn rewards as you grow</p></div></div></div><div style="width:100%;animation:fadeUp 0.7s var(--smooth) 0.3s both;"><button class="btn btn-primary btn-full" onclick="SFX.tap();navigateTo('screen-setup')" style="font-size:16px;padding:16px;">Get Started</button><div style="margin-top:10px;"><button class="btn btn-ghost btn-full" onclick="SFX.tap();loadExisting()">I already have a profile</button></div></div></div></div>
<div class="screen" id="screen-setup"><div class="topbar"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;">Step 1 of 2</span></div><div class="scroll-body"><div class="setup-body"><div class="setup-h">Create your profile</div><div class="setup-sub">Everything stays on your device.</div><div class="form-group"><label class="form-label">Your Name</label><input class="form-input" id="inp-name" type="text" placeholder="e.g. Maria Santos" maxlength="30"></div><div class="form-group"><label class="form-label">Profile Picture</label><div class="avatar-grid" id="av-grid"></div></div><div class="form-group"><label class="form-label">Grade Level</label><div class="grade-grid" id="gr-grid"></div></div><button class="btn btn-primary btn-full" onclick="SFX.tap();saveProfile()">Next: Take the Assessment</button></div></div></div>
<div class="screen" id="screen-quiz"><div class="quiz-header"><div style="display:flex;align-items:center;margin-bottom:10px;"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo" style="font-size:16px;">StudyBuddy</div></div><span style="font-size:12px;color:var(--text3);font-weight:700;margin-left:auto;">Assessment</span></div><div class="quiz-prog-bar"><div class="quiz-prog-fill" id="q-prog" style="width:2%"></div></div><div class="quiz-meta"><span id="q-num">Q1 / 30</span><span id="q-hint" style="color:var(--purple);">Results at Q30</span></div></div><div class="quiz-body" id="q-body"></div><div class="quiz-footer"><button class="btn btn-secondary" onclick="SFX.tap();qPrev()" id="q-prev" style="width:80px;">Back</button><button class="btn btn-primary" onclick="SFX.tap();qNext()" id="q-next" style="flex:1;">Next</button></div></div>
<div class="screen" id="screen-results"><div class="scroll-body"><div class="results-hero"><span class="results-bigicon"></span><div class="results-h">Your Results Are In!</div><div class="results-sub" id="r-sub"></div></div><div class="results-body" id="r-body"></div><div style="padding:0 18px 24px;"><button class="btn btn-primary btn-full" onclick="SFX.success();goToHome()">Start Learning</button></div></div></div>
<div class="screen" id="screen-home"><div class="topbar"><div class="topbar-logo-wrap"><div class="topbar-logo-icon"></div><div class="topbar-logo">StudyBuddy</div></div><div style="display:flex;align-items:center;gap:10px;"><div class="cookie-badge" id="cookie-display" onclick="SFX.pop();showToast(' Earn cookies by studying!')"><span class="cookie-icon"></span><span class="cookie-count" id="cookie-count">0</span></div><div class="theme-toggle" onclick="toggleTheme()"><div class="theme-toggle-knob" id="theme-knob"></div></div><span id="home-av" style="font-size:24px;cursor:pointer;" onclick="SFX.tap();showPfpChangeModal()"></span></div></div><div class="scroll-body home-scroll" id="home-body"><div class="greeting"><div class="greeting-hi" id="greeting-time">Welcome back,</div><div class="greeting-name" id="g-name">Learner!</div></div>
<div class="pet-lv-card"><span class="pet-lv-icon" id="pet-lv-emoji"></span><div class="pet-lv-info"><div class="pet-lv-lbl"><span id="pet-lv-name">Cappy  Lv 1</span><span id="pet-lv-progress">0/10 feeds</span></div><div class="pet-lv-track"><div class="pet-lv-fill" id="pet-lv-bar" style="width:0%"></div></div></div></div>
<div class="streak-card"><div class="streak-days" id="streak-days"></div><div class="streak-stat"><div class="streak-num" id="streak-n">0</div><div class="streak-lbl">Streak</div></div></div>
<div class="capy-home-wrap" id="capy-widget"><div class="capy-container" id="capy-container"><div class="capy-bubble" id="capy-bubble"><span class="bubble-icon"></span> <span id="capy-bubble-text">Hi there!</span></div><div class="capy-scene" id="capy-scene" onclick="onCapyClick(event)"><div class="capy-svg-wrap" id="capy-body"><svg viewBox="0 0 220 220" xmlns="http://www.w3.org/2000/svg" width="110" height="110"><ellipse cx="110" cy="205" rx="55" ry="8" fill="rgba(0,0,0,0.08)"/><ellipse cx="72" cy="188" rx="22" ry="16" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="148" cy="188" rx="22" ry="16" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="110" cy="145" rx="68" ry="62" fill="#deb887" stroke="#7a5c3a" stroke-width="2.5"/><ellipse cx="60" cy="155" rx="18" ry="14" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="160" cy="155" rx="18" ry="14" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="110" cy="155" rx="38" ry="30" fill="rgba(255,255,255,0.12)"/><circle cx="110" cy="82" r="52" fill="#deb887" stroke="#7a5c3a" stroke-width="2.5"/><ellipse cx="68" cy="48" rx="14" ry="12" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="68" cy="48" rx="8" ry="7" fill="#c4a47a"/><ellipse cx="152" cy="48" rx="14" ry="12" fill="#b08860" stroke="#7a5c3a" stroke-width="2"/><ellipse cx="152" cy="48" rx="8" ry="7" fill="#c4a47a"/><ellipse cx="110" cy="95" rx="28" ry="22" fill="#c4a47a" stroke="#7a5c3a" stroke-width="1.5"/><line x1="110" y1="88" x2="110" y2="102" stroke="#7a5c3a" stroke-width="2.5" stroke-linecap="round"/><circle cx="105" cy="88" r="2" fill="#7a5c3a"/><circle cx="115" cy="88" r="2" fill="#7a5c3a"/><g id="capy-eyes"><path d="M85 72 Q92 67 99 72" stroke="#5a3a1a" stroke-width="2.5" fill="none" stroke-linecap="round"/><path d="M121 72 Q128 67 135 72" stroke="#5a3a1a" stroke-width="2.5" fill="none" stroke-linecap="round"/></g><g id="capy-eyes-open" style="display:none"><circle cx="92" cy="70" r="5" fill="#5a3a1a"/><circle cx="128" cy="70" r="5" fill="#5a3a1a"/><circle cx="93.5" cy="68.5" r="1.5" fill="#fff"/><circle cx="129.5" cy="68.5" r="1.5" fill="#fff"/></g><ellipse cx="74" cy="85" rx="10" ry="6" fill="rgba(234,140,160,0.35)"/><ellipse cx="146" cy="85" rx="10" ry="6" fill="rgba(234,140,160,0.35)"/><path id="capy-mouth" d="M104 104 Q110 110 116 104" stroke="#7a5c3a" stroke-width="1.8" fill="none" stroke-linecap="round"/></svg></div><div id="capy-zzz-wrap"></div></div><div class="capy-shadow"></div><div class="capy-info"><div class="capy-name-wrap"><div class="capy-name"><span id="capy-pet-name">Cappy</span> <span class="capy-level-badge" id="capy-lv-badge">Lv 1</span></div><div class="capy-mood" id="capy-mood-text"> Happy & content</div></div></div><div class="capy-stats"><div class="capy-stat"><div class="capy-stat-label"> Fullness</div><div class="capy-stat-bar"><div class="capy-stat-fill capy-hunger-fill" id="capy-hunger-bar" style="width:80%"></div></div></div><div class="capy-stat"><div class="capy-stat-label"> Happiness</div><div class="capy-stat-bar"><div class="capy-stat-fill capy-happy-fill" id="capy-happy-bar" style="width:80%"></div></div></div></div><div class="capy-actions"><button class="capy-feed-btn" id="capy-feed-btn" onclick="event.stopPropagation();feedCapy()"> Feed <span class="feed-cost">(1 )</span></button><button class="capy-pet-btn" onclick="event.stopPropagation();petCapy()"> Pet</button></div></div></div>
<div class="section-label">Recommended Techniques</div><div class="tech-grid" id="home-tech-grid"></div><div class="section-label">Quick Actions</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;"><button class="btn btn-secondary" onclick="SFX.tap();switchNav('schedule')">Schedule</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav('achievements')">Awards</button></div><div class="section-label">Daily Tip</div><div class="tip-card" id="daily-tip"><p></p></div></div><div class="bottom-nav" id="home-nav"><div class="nav-item active" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-study"><div class="topbar"><div class="topbar-title">Study Tools</div></div><div class="scroll-body" style="padding:14px;" id="study-list-body"></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-schedule"><div class="topbar"><div class="topbar-title">My Schedule</div><button class="btn btn-sm btn-primary" onclick="SFX.tap();showAddSessionModal()">+ Add</button></div><div class="scroll-body" style="padding:14px;" id="sched-body"><div class="section-label">This Week</div><div class="sched-week" id="sched-week"></div><div class="section-label" style="margin-top:14px;">Sessions</div><div id="sess-list"></div><div style="margin-top:10px;"><button class="btn btn-secondary btn-full" onclick="SFX.tap();toggleRest()">Toggle Rest Day Today</button></div><div class="section-label" style="margin-top:20px;">Pomodoro Timer</div><div class="timer-wrap"><div class="timer-ring" id="timer-ring">25:00</div><div class="timer-phase" id="timer-phase">Focus Session</div><div id="pomo-dur-adjuster"></div><div style="display:flex;gap:10px;justify-content:center;"><button class="btn btn-primary" onclick="SFX.tap();toggleTimer()" id="timer-btn">Start</button><button class="btn btn-secondary" onclick="SFX.tap();resetTimer()">Reset</button></div></div></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-achievements"><div class="topbar"><div class="topbar-title">Achievements</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="ach-count">0/18</span></div><div class="scroll-body" style="padding:14px;"><div class="ach-grid" id="ach-grid"></div></div><div class="bottom-nav"><div class="nav-item" onclick="SFX.tap();switchNav('home')"><span class="nav-icon"></span><span class="nav-label">Home</span></div><div class="nav-item" onclick="SFX.tap();switchNav('study')"><span class="nav-icon"></span><span class="nav-label">Study</span></div><div class="nav-item" onclick="SFX.tap();switchNav('schedule')"><span class="nav-icon"></span><span class="nav-label">Schedule</span></div><div class="nav-item active" onclick="SFX.tap();switchNav('achievements')"><span class="nav-icon"></span><span class="nav-label">Awards</span></div></div></div>
<div class="screen" id="screen-flashcards"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Flashcards</div></div><div class="fc-tabs"><div class="fc-tab active" onclick="switchFcTab('decks',this)">Decks</div><div class="fc-tab" onclick="switchFcTab('create',this)">Create</div><div class="fc-tab" onclick="switchFcTab('ai',this)">AI Gen</div></div><div class="fc-section active" id="fc-decks"></div><div class="fc-section" id="fc-create"></div><div class="fc-section" id="fc-ai"></div><div class="fc-section" id="fc-study"></div></div>
<div class="screen" id="screen-blurting"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Blurting</div></div><div class="scroll-body tech-body" id="blurt-body"></div></div>
<div class="screen" id="screen-question"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Question Method</div></div><div class="scroll-body tech-body" id="cornell-body"></div></div>
<div class="screen" id="screen-feynman"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Feynman Technique</div></div><div class="scroll-body tech-body" id="feynman-body"></div></div>
<div class="screen" id="screen-rrr"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Read, Recite, Review</div></div><div class="scroll-body tech-body" id="rrr-body"></div></div>
<div class="screen" id="screen-whiteboard"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Brain Dump</div></div><div class="wb-topbar" id="wb-toolbar"></div><div class="wb-canvas-wrap"><canvas id="wbCanvas"></canvas></div><div style="padding:10px 14px;border-top:1px solid var(--border);display:flex;gap:8px;flex-shrink:0;background:var(--glass);backdrop-filter:blur(16px);"><button class="btn btn-secondary btn-sm" onclick="SFX.undo();wbUndo()"> Undo</button><button class="btn btn-secondary btn-sm" onclick="SFX.erase();wbClear()">Clear</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();wbSave()">Save</button></div></div>
<div class="screen" id="screen-diagram"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Active Diagramming</div></div><div class="diag-toolbar" id="diag-toolbar"></div><div class="diag-canvas-wrap" id="diag-wrap"><canvas id="diagCanvas"></canvas><div class="diag-nodes-layer" id="diag-nodes"></div></div><div class="diag-bottom-bar"><button class="btn btn-danger btn-sm" onclick="SFX.tap();diagClear()">Clear</button><button class="btn btn-secondary btn-sm" onclick="SFX.tap();diagConnect()">Connect</button><button class="btn btn-primary btn-sm" style="flex:1;" onclick="SFX.tap();diagSave()">Save</button></div></div>
<div class="screen" id="screen-mcq"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">Multiple Choice Test</div></div><div class="test-tabs"><div class="test-tab active" onclick="switchTestTab('mcq','generate',this)">Generate</div><div class="test-tab" onclick="switchTestTab('mcq','take',this)">Take Test</div><div class="test-tab" onclick="switchTestTab('mcq','results',this)">Results</div></div><div class="test-section active" id="mcq-generate"></div><div class="test-section" id="mcq-take"></div><div class="test-section" id="mcq-results"></div></div>
<div class="screen" id="screen-tf"><div class="topbar"><div class="back-btn" onclick="SFX.tap();goBack()">&#8592;</div><div class="topbar-title">True or False Test</div></div><div class="test-tabs"><div class="test-tab active" onclick="switchTestTab('tf','generate',this)">Generate</div><div class="test-tab" onclick="switchTestTab('tf','take',this)">Take Test</div><div class="test-tab" onclick="switchTestTab('tf','results',this)">Results</div></div><div class="test-section active" id="tf-generate"></div><div class="test-section" id="tf-take"></div><div class="test-section" id="tf-results"></div></div>
<div class="screen" id="screen-saved"><div class="topbar"><div class="back-btn" onclick="SFX.tap();switchNav('study')">&#8592;</div><div class="topbar-title">Saved Reviews</div><span style="font-size:12px;color:var(--text2);font-weight:700;" id="saved-count">0</span></div><div class="scroll-body" style="padding:14px;" id="saved-body"></div></div>
<div class="screen" id="screen-saved-detail"><div class="topbar"><div class="back-btn" onclick="SFX.tap();navigateTo('screen-saved','down')">&#8592;</div><div class="topbar-title" id="saved-detail-title">Review Detail</div></div><div class="scroll-body" style="padding:14px;" id="saved-detail-body"></div></div>
<div class="modal-overlay" id="session-modal"><div class="modal-content"><div class="modal-close" onclick="hideAddSessionModal()"></div><div class="modal-title"> New Study Session</div><div class="modal-subtitle">Plan your study session</div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="modal-subject" placeholder="e.g. Biology Chapter 5"></div><div class="form-group"><label class="form-label">Technique</label><select class="form-input" id="modal-technique"><option value="flashcards">Flashcards</option><option value="blurting">Blurting</option><option value="question">Question Method</option><option value="feynman">Feynman Technique</option><option value="rrr">Read, Recite, Review</option><option value="whiteboard">Brain Dump</option><option value="diagram">Active Diagramming</option><option value="mcq">Multiple Choice Test</option><option value="tf">True or False Test</option></select></div><div class="form-group"><label class="form-label">Duration (minutes)</label><input class="form-input" id="modal-duration" type="number" value="30" min="5" max="180"></div><div class="form-group"><label class="form-label">Date</label><input class="form-input" id="modal-date" type="date"></div><div class="form-group"><label class="form-label">Time</label><div style="text-align:center;cursor:pointer;padding:10px;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--r);font-weight:800;color:var(--purple);" onclick="showTimePicker()" id="modal-time-display">2:00 PM - Tap to change</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;"><button class="btn btn-secondary" onclick="hideAddSessionModal()">Cancel</button><button class="btn btn-primary" onclick="SFX.correct();confirmAddSession()">Add Session</button></div></div></div>
<div class="modal-overlay" id="time-modal"><div class="modal-content"><div class="modal-close" onclick="hideTimePicker()"></div><div class="modal-title"> Set Time</div><div class="modal-subtitle">Pick when to study</div><div class="time-picker-wrap"><div class="time-col"><div class="time-spin-btn" onclick="spinTime('h',1)"></div><div class="time-display" id="tp-hour">02</div><div class="time-spin-btn" onclick="spinTime('h',-1)"></div></div><div class="time-sep">:</div><div class="time-col"><div class="time-spin-btn" onclick="spinTime('m',1)"></div><div class="time-display" id="tp-min">00</div><div class="time-spin-btn" onclick="spinTime('m',-1)"></div></div><div class="time-ampm"><div class="ampm-btn active" id="tp-pm-am" onclick="setAMPM('AM')">AM</div><div class="ampm-btn" id="tp-pm-pm" onclick="setAMPM('PM')">PM</div></div></div><div class="time-presets" id="time-presets"></div><button class="btn btn-primary btn-full" style="margin-top:16px;" onclick="confirmTimePick()">Confirm</button></div></div>
<div class="modal-overlay" id="pfp-modal"><div class="modal-content"><div class="modal-close" onclick="hidePfpModal()"></div><div class="modal-title"> Change Profile Picture</div><div class="modal-subtitle">Choose an avatar or upload a photo</div><div class="avatar-grid" id="pfp-av-grid" style="margin-bottom:14px;"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;"><button class="btn btn-secondary" onclick="hidePfpModal()">Cancel</button><button class="btn btn-primary" onclick="SFX.correct();confirmPfpChange()">Save</button></div></div></div>
<div class="toast" id="toast"></div>
<div class="ach-popup" id="ach-popup"><span class="ach-pop-icon" id="ap-icon"></span><div class="ach-pop-text"><h4>Achievement Unlocked!</h4><p id="ap-name"></p></div></div>
</div>

<script>
(function(){var pc=document.getElementById('splash-particles');for(var i=0;i<15;i++){var p=document.createElement('div');p.className='splash-particle';var sz=3+Math.random()*10;p.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+Math.random()*100+'%;background:rgba('+(200+Math.random()*55)+','+(150+Math.random()*105)+','+(200+Math.random()*55)+',0.25);animation-duration:'+(5+Math.random()*8)+'s;animation-delay:'+Math.random()*5+'s;';pc.appendChild(p)}var sc=document.getElementById('splash-stars');for(var i=0;i<40;i++){var s=document.createElement('div');s.className='splash-star';var sz=1+Math.random()*2.5;s.style.cssText='width:'+sz+'px;height:'+sz+'px;left:'+Math.random()*100+'%;top:'+Math.random()*100+'%;animation-duration:'+(1.5+Math.random()*3)+'s;animation-delay:'+Math.random()*3+'s;';sc.appendChild(s)}})();

// PERFORMANCE OPTIMIZATION: RAF-based SFX scheduler
var SFX=(function(){var ctx,scheduled={},rafId=null;function C(){if(!ctx)try{ctx=new(window.AudioContext||window.webkitAudioContext)}catch(e){}return ctx}function P(f,t,d,v){var c=C();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type=t||'sine';o.frequency.value=f;g.gain.setValueAtTime(v||0.08,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+(d||0.1));o.start();o.stop(c.currentTime+(d||0.1)+0.05)}catch(e){}}function ch(a,t,d){a.forEach(function(x,i){schedule(function(){P(x,t,d,0.07)},i*55)})}function schedule(fn,delay){var id=Date.now()+Math.random();scheduled[id]={fn:fn,time:performance.now()+delay};if(!rafId)rafId=requestAnimationFrame(processSchedule);return id}function processSchedule(now){rafId=null;var toRun=[];for(var id in scheduled){if(scheduled[id].time<=now){toRun.push(scheduled[id].fn);delete scheduled[id]}}toRun.forEach(function(fn){try{fn()}catch(e){}});if(Object.keys(scheduled).length>0)rafId=requestAnimationFrame(processSchedule)}return{tap:function(){P(520,'triangle',0.05,0.06)},select:function(){P(523,'sine',0.06,0.07);schedule(function(){P(659,'sine',0.06,0.05)},45)},correct:function(){ch([523,659,784],'sine',0.12)},success:function(){ch([523,659,784,1047],'sine',0.18)},flip:function(){P(660,'triangle',0.04,0.05);schedule(function(){P(880,'triangle',0.03,0.04)},35)},unlock:function(){P(784,'sine',0.1,0.09);schedule(function(){P(1047,'sine',0.12,0.1)},100);schedule(function(){P(1319,'sine',0.15,0.12)},200)},error:function(){P(200,'sawtooth',0.08,0.05);schedule(function(){P(180,'sawtooth',0.06,0.04)},60)},whoosh:function(){var c=C();if(!c)return;try{var o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.type='sine';o.frequency.setValueAtTime(700,c.currentTime);o.frequency.exponentialRampToValueAtTime(200,c.currentTime+0.18);g.gain.setValueAtTime(0.05,c.currentTime);g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+0.18);o.start();o.stop(c.currentTime+0.2)}catch(e){}},timer:function(){ch([880,1108,1320],'sine',0.18)},navigate:function(){P(440,'triangle',0.04,0.04);schedule(function(){P(554,'triangle',0.04,0.03)},30)},pop:function(){P(880,'sine',0.03,0.04)},erase:function(){P(300,'triangle',0.05,0.03)},undo:function(){P(400,'triangle',0.05,0.04);schedule(function(){P(350,'triangle',0.04,0.03)},35)},startup:function(){schedule(function(){P(392,'sine',0.1,0.05)},0);schedule(function(){P(440,'sine',0.1,0.05)},110);schedule(function(){P(523,'sine',0.1,0.06)},220);schedule(function(){P(659,'sine',0.12,0.07)},350);schedule(function(){P(784,'sine',0.15,0.08)},480);schedule(function(){ch([784,988,1175],'sine',0.2)},620)},alarm:function(){try{var c2=new(window.AudioContext||window.webkitAudioContext)();function pn(f,s,d){var o=c2.createOscillator(),g=c2.createGain();o.connect(g);g.connect(c2.destination);o.type='sine';o.frequency.value=f;g.gain.setValueAtTime(0.12,c2.currentTime+s);g.gain.exponentialRampToValueAtTime(0.001,c2.currentTime+s+d);o.start(c2.currentTime+s);o.stop(c2.currentTime+s+d+0.05)}pn(880,0,0.15);pn(1100,0.18,0.15);pn(880,0.36,0.15);pn(1100,0.54,0.15);pn(1320,0.72,0.25)}catch(e){}},notifSound:function(){try{var c2=new(window.AudioContext||window.webkitAudioContext)();function pn(f,s,d){var o=c2.createOscillator(),g=c2.createGain();o.connect(g);g.connect(c2.destination);o.type='triangle';o.frequency.value=f;g.gain.setValueAtTime(0.1,c2.currentTime+s);g.gain.exponentialRampToValueAtTime(0.001,c2.currentTime+s+d);o.start(c2.currentTime+s);o.stop(c2.currentTime+s+d+0.05)}pn(660,0,0.12);pn(880,0.14,0.12);pn(1047,0.3,0.18)}catch(e){}}}})();

// PERFORMANCE: Object pool for particles to reduce GC
var particlePool=[],maxParticles=50;
function getParticle(){if(particlePool.length>0)return particlePool.pop();return document.createElement('div')}
function releaseParticle(p){if(particlePool.length<maxParticles){p.className='';p.style.cssText='';particlePool.push(p)}}
function burst(x,y,c,n){c=c||['#8b5cf6','#ec4899','#fbbf24','#10b981'];n=n||12;var fragment=document.createDocumentFragment();for(var i=0;i<n;i++){var p=getParticle();p.className='particle';var a=(i/n)*360,d=40+Math.random()*70;p.style.cssText='left:'+x+'px;top:'+y+'px;width:'+(4+Math.random()*8)+'px;height:'+(4+Math.random()*8)+'px;background:'+c[i%c.length]+';--tx:'+Math.cos(a*Math.PI/180)*d+'px;--ty:'+Math.sin(a*Math.PI/180)*d+'px;animation-duration:'+(0.6+Math.random()*0.4)+'s;';fragment.appendChild(p)}document.body.appendChild(fragment);setTimeout(function(){var particles=document.querySelectorAll('.particle');particles.forEach(function(p){if(p.parentNode){p.parentNode.removeChild(p);releaseParticle(p)}})},1200)}

var currentTheme=localStorage.getItem('sb-theme')||'light';
function applyTheme(){document.documentElement.setAttribute('data-theme',currentTheme);var k=document.getElementById('theme-knob');if(k)k.textContent=currentTheme==='dark'?'':''}
function toggleTheme(){currentTheme=currentTheme==='light'?'dark':'light';localStorage.setItem('sb-theme',currentTheme);applyTheme();SFX.select()}
applyTheme();

var AVATARS=['','','','','','','','','',''];
var GRADES=['Grade 7','Grade 8','Grade 9','Grade 10','Grade 11','Grade 12','College'];
var DECK_COLORS=['#8b5cf6','#ec4899','#fbbf24','#10b981','#3b82f6','#f97316','#14b8a6','#ef4444'];

var TECHNIQUES=[
{id:'flashcards',name:'Flashcards',icon:'',cval:'#3b82f6',soft:'var(--blue-soft)',screen:'screen-flashcards',desc:'Spaced repetition for rapid recall'},
{id:'blurting',name:'Blurting',icon:'',cval:'#ec4899',soft:'var(--pink-soft)',screen:'screen-blurting',desc:'Active recall through free writing'},
{id:'question',name:'Question Method',icon:'',cval:'#10b981',soft:'var(--green-soft)',screen:'screen-question',desc:'Cornell note-taking and self-quiz'},
{id:'feynman',name:'Feynman Technique',icon:'',cval:'#f97316',soft:'var(--orange-soft)',screen:'screen-feynman',desc:'Learn by teaching simply'},
{id:'rrr',name:'Read, Recite, Review',icon:'',cval:'#14b8a6',soft:'var(--teal-soft)',screen:'screen-rrr',desc:'Structured reading cycle'},
{id:'whiteboard',name:'Brain Dump',icon:'',cval:'#fbbf24',soft:'var(--yellow-soft)',screen:'screen-whiteboard',desc:'Free-form canvas drawing'},
{id:'diagram',name:'Active Diagramming',icon:'',cval:'#8b5cf6',soft:'rgba(139,92,246,0.12)',screen:'screen-diagram',desc:'Mind maps and visual thinking'}
];

var TEST_METHODS=[
{id:'mcq',name:'Multiple Choice',icon:'',cval:'#6366f1',soft:'rgba(99,102,241,0.12)',screen:'screen-mcq',desc:'Auto-generated MCQ tests'},
{id:'tf',name:'True or False',icon:'',cval:'#059669',soft:'rgba(5,150,105,0.12)',screen:'screen-tf',desc:'Auto-generated T/F quizzes'}
];

var ALL_METHODS=TECHNIQUES.concat(TEST_METHODS);
function getTechMap(){var tm={};ALL_METHODS.forEach(function(t){tm[t.id]=t});return tm}

var QUESTIONS=[
{scenario:"You have a big exam tomorrow and you realize you haven't reviewed everything yet.",q:"What's the first thing you do?",opts:[{label:"Go through all my notes carefully section by section, then try to recall the key points afterwards",w:{rrr:5,question:2}},{label:"Grab a blank sheet and write down everything I already remember without looking at anything",w:{blurting:5,whiteboard:2}},{label:"Pull out the important terms and pair each one with its meaning so I can drill them quickly",w:{flashcards:5,question:2}},{label:"Talk myself through each topic out loud as if I'm explaining it to someone sitting next to me",w:{feynman:5,blurting:2}},{label:"Lay out all the topics on paper and draw arrows showing how everything connects together",w:{diagram:5,whiteboard:3}}]},
{scenario:"You're on a 20-minute commute to school and want to use the time to study.",q:"How do you make the most of that travel time?",opts:[{label:"Flip through a set of question-and-answer pairs I prepared earlier on my phone",w:{flashcards:5}},{label:"Close my eyes and mentally walk through everything I studied the night before",w:{blurting:4,feynman:3}},{label:"Scribble down key ideas on whatever paper I have with me",w:{blurting:5,whiteboard:2}},{label:"Reread the highlighted parts of my notes one more time",w:{rrr:5}},{label:"Think about what questions might come up in class and rehearse answers in my head",w:{question:5,flashcards:2}}]},
{scenario:"Your friends are all busy tonight. You have to review alone for tomorrow's quiz.",q:"What do you do for your solo study session?",opts:[{label:"Read through each section of my notes, cover them up, and try to recite what I just read",w:{rrr:5,blurting:2}},{label:"Pretend someone is sitting beside me and explain the material out loud to them",w:{feynman:5}},{label:"Get a big piece of paper and sketch how all the topics connect using colored pens",w:{diagram:5,whiteboard:3}},{label:"Write everything I can remember on scratch paper, then check my notes to find the gaps",w:{blurting:5}},{label:"Make up practice questions that could appear on the quiz and try answering them myself",w:{question:5,flashcards:3}}]},
{scenario:"You scored poorly on a practice test and the real exam is in 5 days.",q:"How do you plan your comeback study strategy?",opts:[{label:"Look at every wrong answer and figure out the simplest way to explain why it's actually wrong",w:{feynman:5,question:2}},{label:"Reread the sections where I'm weakest more slowly and check my understanding after each part",w:{rrr:5}},{label:"List all the concepts I got wrong and drill them over and over until they finally stick",w:{flashcards:4,blurting:3}},{label:"Create a chart showing which topics I know well vs. which ones I don't, then attack the gaps",w:{diagram:5}},{label:"Close my materials and try to solve the same problems from memory to see exactly where I freeze",w:{blurting:5,whiteboard:2}}]},
{scenario:"You just finished reading a long assigned chapter for homework.",q:"After reading it once, what's your next step?",opts:[{label:"Put the reading down and try to write a summary entirely in my own simple words",w:{feynman:5,blurting:3}},{label:"Read it again more carefully, then close it and recite the important details from memory",w:{rrr:5}},{label:"Draw a timeline or visual map of the events and key ideas mentioned in the chapter",w:{diagram:5,whiteboard:3}},{label:"Pick out the key names, terms, and concepts and make quick review pairs for each one",w:{flashcards:5}},{label:"Write three questions that the chapter answers, then try to answer them without looking back",w:{question:5,rrr:2}}]},
{scenario:"You need to memorize 30 vocabulary terms and their definitions for a quiz this week.",q:"What approach works best for you?",opts:[{label:"Pair each term with its definition and go through them repeatedly in short focused bursts",w:{flashcards:5}},{label:"Group the terms by theme and arrange them in a visual layout showing their connections",w:{diagram:5,whiteboard:3}},{label:"Read through the whole list several times, cover it, then try reciting every term back",w:{rrr:5}},{label:"Write down as many terms and definitions as I can from memory, check what I missed, and repeat",w:{blurting:5}},{label:"Use each term in a simple sentence and explain it like I'm teaching a younger student",w:{feynman:4,question:3}}]},
{scenario:"You're reviewing for a major exam and need to refresh your memory on many topics.",q:"How do you organize your memory refresh?",opts:[{label:"Write down every topic, detail, and key point I can remember without looking at any notes",w:{blurting:5}},{label:"Reread the summary sections then close the book and try to recall everything in order",w:{rrr:5}},{label:"Create a visual storyline connecting all topics together in a timeline or web",w:{diagram:5,whiteboard:3}},{label:"Come up with potential essay or short-answer questions and outline my answers for each",w:{question:5,feynman:2}},{label:"Go through key terms and facts one by one, testing myself back and forth quickly",w:{flashcards:5,question:2}}]},
{scenario:"A classmate messages you asking for help understanding today's lesson.",q:"How do you help them over chat?",opts:[{label:"Type out a simplified explanation using everyday examples they can easily relate to",w:{feynman:5}},{label:"Send them a photo of a quick sketch or diagram I drew to explain it visually",w:{diagram:4,whiteboard:4}},{label:"Send them a series of simple questions that guide them step by step to figure it out themselves",w:{question:5,flashcards:2}},{label:"Tell them to reread the specific section slowly and try to summarize it back to me in their own words",w:{rrr:4,blurting:3}},{label:"Ask them to write down what they DO understand first, then we work together to fill in what's missing",w:{blurting:5,feynman:2}}]},
{scenario:"There's a power outage and you can't use your phone or laptop to study tonight.",q:"What do you do with just a notebook and a pen?",opts:[{label:"Write down everything I remember about tomorrow's topics on blank pages from memory",w:{blurting:5}},{label:"Draw concept maps and diagrams connecting all the main ideas visually",w:{diagram:5,whiteboard:4}},{label:"Write questions on one side of the page and answers on the other, then quiz myself",w:{question:4,flashcards:4}},{label:"Reread my handwritten notes slowly and carefully, section by section",w:{rrr:5}},{label:"Write a simple explanation of each topic as if I'm creating a tutorial for a beginner",w:{feynman:5,blurting:2}}]},
{scenario:"You have 5 different topics to review across multiple classes in just 3 days.",q:"How do you organize your review across all of them?",opts:[{label:"Assign specific time blocks per topic and go through each one systematically and thoroughly",w:{rrr:5}},{label:"Create a master visual overview connecting all topics so I can see the big picture first",w:{diagram:5,whiteboard:2}},{label:"Start each topic by writing everything I know, then focus my energy on what I clearly missed",w:{blurting:5,feynman:2}},{label:"Build a quick set of key terms and definitions for each topic to drill throughout the day",w:{flashcards:5}},{label:"Prepare practice questions for each topic and quiz myself at the end of every study session",w:{question:5}}]},
{scenario:"You keep reading the same page over and over but nothing seems to be sinking in.",q:"What do you switch to instead?",opts:[{label:"Close the material and write everything I understood from that page without looking back at it",w:{blurting:5}},{label:"Grab scratch paper and sketch what I just read as a simple diagram or visual",w:{diagram:4,whiteboard:3}},{label:"Try to explain the content to myself out loud in the simplest way I possibly can",w:{feynman:5}},{label:"Turn the key points into quick pairs and start testing myself back and forth on them",w:{flashcards:4,question:2}},{label:"Read it out loud more slowly, pause after each paragraph, and try to recite what I just read",w:{rrr:5}}]},
{scenario:"After a full review session at home, you want to check if you actually learned the material.",q:"How do you test yourself?",opts:[{label:"Go through my prepared question-and-answer review set and see how many I get right",w:{flashcards:5}},{label:"Take a blank paper and write absolutely everything I know about the topic from memory",w:{blurting:5,whiteboard:2}},{label:"Answer the practice questions I created earlier from my own notes",w:{question:5}},{label:"Try to teach the entire topic to an imaginary student or my own reflection in a mirror",w:{feynman:5}},{label:"Redraw my visual overview or concept map from memory and see if I can recreate it accurately",w:{diagram:5}}]},
{scenario:"You're learning how a complex process works that has multiple connected stages.",q:"What helps you understand all the connections best?",opts:[{label:"Draw the process with arrows, labels, and colors showing each stage and how they relate",w:{diagram:5,whiteboard:3}},{label:"Go through each stage and explain it using real-life comparisons I can personally relate to",w:{feynman:5}},{label:"Read the explanation carefully, then close everything and recite each stage in the correct order",w:{rrr:5}},{label:"Create quick pairs for each stage  the name on one side, what happens on the other",w:{flashcards:5}},{label:"Write the entire process from memory on a blank sheet and then check what I got wrong",w:{blurting:5}}]},
{scenario:"You and your classmates are working together on a group project presentation.",q:"What role do you naturally take in the group?",opts:[{label:"I make sure everyone actually understands the topic by breaking it down simply for the whole group",w:{feynman:5}},{label:"I create the visual presentation materials  charts, infographics, layouts, and posters",w:{diagram:5,whiteboard:3}},{label:"I prepare review questions to make sure the group is ready if anyone asks us tough questions",w:{question:5,flashcards:3}},{label:"I compile and organize all the research material for everyone to read through systematically",w:{rrr:4,blurting:2}},{label:"I do the brainstorming  writing down all our ideas freely on a big sheet before we organize them",w:{whiteboard:5,blurting:2}}]},
{scenario:"You watched a really helpful tutorial video but you can't rewatch it later.",q:"How do you make sure you remember what you learned from it?",opts:[{label:"Immediately write down the key concepts and pair them together for quick review later",w:{flashcards:5}},{label:"Right after watching, write everything I remember from the video on paper before I forget",w:{blurting:5,rrr:2}},{label:"Sketch the steps and examples from the video as a visual reference I can look at later",w:{diagram:5}},{label:"Write questions based on what the video taught and then answer them myself from memory",w:{question:5}},{label:"Try to re-explain the video's content in my own words as simply as I possibly can",w:{feynman:5}}]},
{scenario:"Your teacher announced a surprise oral quiz tomorrow on yesterday's lesson.",q:"You have tonight to prepare. What's your strategy?",opts:[{label:"Read through yesterday's notes, cover them up, and practice reciting the answers out loud",w:{rrr:5}},{label:"Guess what questions might be asked and prepare confident answers for each one in advance",w:{question:5,flashcards:2}},{label:"Write everything I remember from yesterday's class first, then review only what I forgot",w:{blurting:5}},{label:"Explain each concept to myself simply and clearly until I feel confident about any possible question",w:{feynman:5}},{label:"Organize the lesson's main points visually so I can picture the layout in my mind during the quiz",w:{diagram:4,whiteboard:3}}]},
{scenario:"You're really struggling to understand a complicated concept that just won't click.",q:"What's your go-to approach when something is truly confusing?",opts:[{label:"Try to explain it as if I'm talking to a much younger person using only simple everyday words",w:{feynman:5}},{label:"Write down everything I DO understand first, then figure out exactly where my confusion starts",w:{blurting:5}},{label:"Reread the material more slowly, taking it one small paragraph at a time before moving on",w:{rrr:5,question:2}},{label:"Create a visual map of the concept showing cause-and-effect relationships between each part",w:{diagram:5,whiteboard:3}},{label:"Break the confusing concept into tiny pieces and create a question-answer pair for each piece",w:{flashcards:5,question:2}}]},
{scenario:"You need to study for two different exams happening on the exact same day.",q:"How do you split your study time between them?",opts:[{label:"Alternate between the two  read a section of one, recite it, then switch to the other and repeat",w:{rrr:5}},{label:"Build a quick set of key terms for each one to drill throughout the entire day in short bursts",w:{flashcards:5}},{label:"For each one, write everything I know from memory first to quickly find my weakest spots",w:{blurting:5,feynman:2}},{label:"Create a side-by-side visual comparison of both sets of main topics to see the big picture",w:{diagram:5,whiteboard:2}},{label:"Prepare practice questions for both and alternate quizzing myself between the two",w:{question:5}}]},
{scenario:"You're trying to learn a new formula or procedure and need to understand how to apply it.",q:"What's your approach to really learning it?",opts:[{label:"Practice applying it to different problems over and over until the steps become automatic",w:{flashcards:4,rrr:3}},{label:"Write a plain-language explanation of what the formula does and exactly when you'd use it",w:{feynman:5}},{label:"Create a visual chart showing when and where each part of the procedure applies",w:{diagram:5}},{label:"Write the formula or steps from memory repeatedly until I can reproduce it perfectly without looking",w:{blurting:5}},{label:"Create practice problems that use the formula and challenge myself to solve them without help",w:{question:5,flashcards:2}}]},
{scenario:"You're reviewing a topic with many different parts and functions to remember.",q:"How do you keep track of all the parts and what each one does?",opts:[{label:"Draw and label a detailed diagram with colors highlighting each part and its function",w:{diagram:5,whiteboard:3}},{label:"Pair each part with its function and drill through them in quick repetitive rounds",w:{flashcards:5}},{label:"Explain each part using real-world comparisons to things I already understand well",w:{feynman:5}},{label:"Write all the parts and functions I remember from memory, then check what I missed and repeat",w:{blurting:5}},{label:"Read the reference material about each part, then close it and try to recite their functions back",w:{rrr:5}}]},
{scenario:"You're preparing for an oral presentation or class report in front of everyone.",q:"How do you get ready for it?",opts:[{label:"Create a visual layout or poster as my guide so I have something to reference during the talk",w:{diagram:5,whiteboard:3}},{label:"Practice explaining the topic out loud simply, as if my audience knows absolutely nothing about it",w:{feynman:5}},{label:"Prepare key points as quick recall prompts and rehearse going through them in order",w:{flashcards:4}},{label:"Write my entire presentation from memory first to see what I know confidently vs. what I don't",w:{blurting:5}},{label:"Read my notes and references multiple times until I feel completely confident about the material",w:{rrr:5}}]},
{scenario:"You keep confusing two similar concepts and mixing them up on tests.",q:"How do you finally make the difference between them stick?",opts:[{label:"Create a side-by-side comparison chart showing exactly what makes each one different",w:{diagram:5,whiteboard:2}},{label:"Explain both concepts to myself simply and focus specifically on what makes each one unique",w:{feynman:5}},{label:"Write both concepts and their differences from memory several times until I stop mixing them up",w:{blurting:5}},{label:"Make quick pairs: one side has the concept name, the other has what's uniquely true about it",w:{flashcards:5}},{label:"Read the definition of each one slowly, then close the book and recite the differences out loud",w:{rrr:5}}]},
{scenario:"It's the weekend and you want to get ahead by pre-studying next week's material.",q:"How do you study material you haven't been taught yet?",opts:[{label:"Read the next chapter's overview first, then try to recall what I just read before continuing",w:{rrr:5}},{label:"Start building a visual overview of the new topics as I encounter and learn each one",w:{diagram:5}},{label:"Write down what little I already know and try to connect it to the new material as I read",w:{feynman:4,blurting:3}},{label:"Create question-answer pairs for every new term or concept I encounter while reading ahead",w:{flashcards:5}},{label:"Write questions that the new material seems to answer and use them to guide my reading",w:{question:5}}]},
{scenario:"Your teacher said the upcoming test will focus heavily on definitions and key terminology.",q:"How do you prepare for a definition-heavy test?",opts:[{label:"Create pairs that match each term with its definition and drill through them systematically",w:{flashcards:5}},{label:"Write practice questions testing each definition and try answering them without looking",w:{question:5}},{label:"Write everything I know about each term from memory to make sure my understanding is complete",w:{blurting:5}},{label:"For each term, explain to myself in the simplest everyday words what it actually means",w:{feynman:5}},{label:"Review all notes by reading through them carefully multiple times and checking my understanding",w:{rrr:5}}]},
{scenario:"You're doing a virtual study session with classmates over video call before the exam.",q:"What role do you naturally fall into during group study?",opts:[{label:"I share my screen and sketch diagrams or mind maps for everyone to follow along with",w:{diagram:5,whiteboard:4}},{label:"I explain things in the simplest way possible when someone in the group gets confused",w:{feynman:5}},{label:"I quiz the group with questions to keep everyone sharp and test what we actually know",w:{question:5,flashcards:3}},{label:"I suggest everyone write what they know first, then we compare and fill in each other's gaps",w:{blurting:5}},{label:"I organize the review by going through the material systematically with everyone step by step",w:{rrr:5}}]},
{scenario:"Your teacher warns the exam will test deep understanding, not just surface-level memorization.",q:"How does this change your study approach?",opts:[{label:"Focus on being able to explain the 'why' behind every concept using simple clear language",w:{feynman:5}},{label:"Build concept maps showing cause-and-effect and how all ideas connect to each other",w:{diagram:5}},{label:"Write out my understanding of each topic from memory to find where my knowledge is shallow",w:{blurting:5}},{label:"Create deep-thinking questions like 'Why does this happen?' and practice answering them fully",w:{question:5}},{label:"Read the material from multiple sources to get a fuller and deeper understanding of each topic",w:{rrr:4,flashcards:2}}]},
{scenario:"You only have 30 minutes before your exam starts and you're already at school.",q:"What's your last-minute review strategy?",opts:[{label:"Quickly go through my prepared question-and-answer review set one final time",w:{flashcards:5}},{label:"Do a final brain dump  write absolutely everything I can remember on scratch paper",w:{blurting:5}},{label:"Glance at my visual overview or concept map for one last quick mental snapshot",w:{diagram:5}},{label:"Explain the hardest concepts to myself one more time to make absolutely sure I understand them",w:{feynman:5}},{label:"Quickly skim through my summary notes one last time before walking into the test",w:{rrr:5}}]},
{scenario:"A younger student asks you to help them study for their upcoming test.",q:"How do you help them learn the material?",opts:[{label:"Break down each topic using the simplest possible explanation with examples from their daily life",w:{feynman:5}},{label:"Draw colorful charts and pictures together to make the material visual, fun, and easy to grasp",w:{diagram:5,whiteboard:3}},{label:"Create a fun quiz game where I ask them questions and they try to answer from memory",w:{question:5,flashcards:3}},{label:"Have them read short sections out loud, then ask them to tell me what they just read in their own words",w:{rrr:5}},{label:"Ask them to write everything they already know first so we can see exactly what to focus on",w:{blurting:5,feynman:2}}]},
{scenario:"You finished studying and feel pretty confident, but you want to truly lock in the knowledge overnight.",q:"What do you do right before bed to solidify what you learned?",opts:[{label:"Quickly flip through my key term pairs one last time to reinforce them before sleep",w:{flashcards:5}},{label:"Write a quick brain dump of everything I studied today to see what stuck and what faded",w:{blurting:5}},{label:"Sketch a quick mini version of my concept map from memory as one final check",w:{diagram:4,whiteboard:3}},{label:"Quietly explain the main ideas to myself in simple words as I'm lying in bed winding down",w:{feynman:5}},{label:"Reread my summary notes one gentle time through to let the information settle in my mind",w:{rrr:5}}]},
{scenario:"You realize you understand a topic on the surface but can't explain the details when asked directly.",q:"How do you deepen your shallow understanding?",opts:[{label:"Try to teach the concept to myself using only simple analogies and absolutely zero technical jargon",w:{feynman:5}},{label:"Map out every detail and sub-detail in a visual web to see what's actually connected to what",w:{diagram:5,whiteboard:3}},{label:"Write everything I think I know, then brutally compare it against the source material for accuracy",w:{blurting:5}},{label:"Create increasingly difficult questions about the topic and force myself to answer each one fully",w:{question:5}},{label:"Go back and reread the source material more carefully, section by section, with full attention",w:{rrr:5}}]}
];

var TIPS=["Spaced repetition is 2-3x more effective than cramming.","The Feynman Technique reveals gaps instantly.","Rest days consolidate memory.","Short sessions beat long marathons.","Blurting shows exactly what you missed.","Color-coding diagrams improves recall by 50%.","Review flashcards right before you'd forget.","Reciting out loud engages more brain."];

var ACHIEVEMENTS_DEF=[{key:'first_profile',icon:'',name:'Identity Found',desc:'Created your profile',rarity:'common'},{key:'quiz_complete',icon:'',name:'Self-Aware Learner',desc:'Completed assessment',rarity:'common'},{key:'first_fc',icon:'',name:'First Flip',desc:'Reviewed first flashcard',rarity:'common'},{key:'first_blurt',icon:'',name:'Brain Unlocked',desc:'Completed Blurting session',rarity:'common'},{key:'first_sched',icon:'',name:'Planner Pro',desc:'Added first session',rarity:'common'},{key:'first_timer',icon:'',name:'Time Keeper',desc:'Completed Pomodoro',rarity:'common'},{key:'first_wb',icon:'',name:'Canvas Pioneer',desc:'Saved first Brain Dump',rarity:'common'},{key:'streak_3',icon:'',name:'On Fire',desc:'3-day streak',rarity:'rare'},{key:'streak_7',icon:'',name:'Unstoppable',desc:'7-day streak',rarity:'rare'},{key:'five_decks',icon:'',name:'Deck Builder',desc:'Created 5 decks',rarity:'rare'},{key:'feynman_5',icon:'',name:'Little Professor',desc:'5 Feynman sessions',rarity:'rare'},{key:'diagram_5',icon:'',name:'Map Maker',desc:'5 diagrams saved',rarity:'rare'},{key:'all_techniques',icon:'',name:'Technique Explorer',desc:'Used all 7 techniques',rarity:'epic'},{key:'hours_10',icon:'',name:'10-Hour Club',desc:'10+ hours studied',rarity:'epic'},{key:'study_balance',icon:'',name:'Balance Master',desc:'3+ rest days',rarity:'epic'},{key:'blurt_10',icon:'',name:'Blurt Champion',desc:'10 Blurting sessions',rarity:'epic'},{key:'all_ach',icon:'',name:'StudyBuddy Legend',desc:'All achievements',rarity:'legendary'},{key:'hours_50',icon:'',name:'Century Scholar',desc:'50+ hours studied',rarity:'legendary'}];

var S={profile:null,quizAnswers:{},scores:{},topTech:null,xp:0,cookies:0,ach:[],sessions:[],restDays:[],streak:0,lastStudy:null,decks:[],techUsed:{},mins:0,feynmanCt:0,diagCt:0,blurtCt:0,savedReviews:[],mcqTests:[],tfTests:[],pfpData:null,capy:null};
var curScreen='',prevScreen='',quizQ=0,isTransitioning=false;
var timerRafId=null,timerLastFrame=0,timerSecs=25*60,timerOn=false,timerPhase='focus',pomoCt=0;
var tpH=2,tpM=0,tpAMPM='PM';
var reviewDuration=25,blurtReviewDur=2;
var NAV_ORDER={home:0,study:1,schedule:2,achievements:3};
var NAV_SCREENS={home:'screen-home',study:'screen-study',schedule:'screen-schedule',achievements:'screen-achievements'};
var selectedAvatarIdx=0,selGr='',pfpMode='emoji',pfpTempData=null,pfpTempMode='emoji',pfpTempIdx=0;

// PERFORMANCE: Debounced save
var saveTimeout=null;
function save(){if(saveTimeout)clearTimeout(saveTimeout);saveTimeout=setTimeout(function(){try{localStorage.setItem('sb7',JSON.stringify(S))}catch(e){}},100)}
function load(){try{var d=localStorage.getItem('sb7');if(d){var p=JSON.parse(d);Object.keys(p).forEach(function(k){S[k]=p[k]});if(!S.savedReviews)S.savedReviews=[];if(!S.mcqTests)S.mcqTests=[];if(!S.tfTests)S.tfTests=[];if(!S.pfpData)S.pfpData=null;if(!S.capy)S.capy=null;if(S.cookies===undefined)S.cookies=0;return true}}catch(e){}return false}
function esc(t){return String(t||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>')}

// PERFORMANCE: RAF-based screen transitions
var transitionRaf=null;
function navigateTo(id,anim){if(isTransitioning||id===curScreen)return;isTransitioning=true;anim=anim||'default';if(transitionRaf)cancelAnimationFrame(transitionRaf);var oldEl=curScreen?document.getElementById(curScreen):null;var newEl=document.getElementById(id);if(!newEl){isTransitioning=false;return}var ec='exiting',nc='entering';if(anim==='left'){ec='exiting-left';nc='entering-left'}else if(anim==='right'){ec='exiting-right';nc='entering-right'}else if(anim==='up'){ec='exiting';nc='entering-up'}else if(anim==='down'){ec='exiting-down';nc='entering'}if(oldEl&&oldEl!==newEl){oldEl.classList.add(ec);transitionRaf=requestAnimationFrame(function(){setTimeout(function(){oldEl.classList.remove('active',ec,'entering','entering-left','entering-right','entering-up','exiting','exiting-left','exiting-right','exiting-down');isTransitioning=false},400)})}setTimeout(function(){newEl.classList.add('active',nc);setTimeout(function(){newEl.classList.remove(nc);isTransitioning=false},550)},oldEl&&oldEl!==newEl?120:0);prevScreen=curScreen;curScreen=id;SFX.navigate()}
function goBack(){navigateTo(prevScreen||'screen-study','down')}

// PERFORMANCE: Passive event listeners for scroll/touch
function switchNav(tab){var scr=NAV_SCREENS[tab];if(!scr||scr===curScreen)return;var cur='home';Object.keys(NAV_SCREENS).forEach(function(k){if(NAV_SCREENS[k]===curScreen)cur=k});SFX.whoosh();navigateTo(scr,NAV_ORDER[tab]>NAV_ORDER[cur]?'left':'right');if(tab==='achievements')renderAch();if(tab==='schedule'){renderSched();renderSessList();renderPomoDurAdjuster()}if(tab==='study')renderStudyList();if(tab==='home')renderHome();setTimeout(function(){document.querySelectorAll('.bottom-nav').forEach(function(nav){nav.querySelectorAll('.nav-item').forEach(function(n,i){n.classList.toggle('active',['home','study','schedule','achievements'][i]===tab)})})},50)}

function openTech(id){if(!S.techUsed)S.techUsed={};S.techUsed[id]=(S.techUsed[id]||0)+1;save();if(Object.keys(S.techUsed).length>=7)unlock('all_techniques');var t=TECHNIQUES.find(function(x){return x.id===id});if(!t)return;switch(id){case'flashcards':initFC();break;case'blurting':initBlurt();break;case'question':initCornell();break;case'feynman':initFeynman();break;case'rrr':initRRR();break;case'whiteboard':navigateTo(t.screen,'up');setTimeout(initWB,300);return;case'diagram':navigateTo(t.screen,'up');setTimeout(initDiag,300);return}navigateTo(t.screen,'up')}
function openTestMethod(id){var t=TEST_METHODS.find(function(x){return x.id===id});if(!t)return;if(id==='mcq')initMCQ();else if(id==='tf')initTF();navigateTo(t.screen,'up')}

function hideSplash(){setTimeout(function(){SFX.startup()},1800);setTimeout(function(){var sp=document.getElementById('splash');sp.classList.add('exit');burst(window.innerWidth/2,window.innerHeight/2,null,20);setTimeout(function(){sp.style.display='none'},1000);if(load()&&S.profile&&S.scores&&Object.keys(S.scores).length>0){renderHome();navigateTo('screen-home')}else{initSetup();navigateTo('screen-welcome')}},4200)}

function buildAvatarGrid(containerId,showUpload,onSelect){var container=document.getElementById(containerId);if(!container)return;var html=AVATARS.map(function(a,i){return'<div class="av-opt" data-idx="'+i+'" data-type="emoji">'+a+'</div>'}).join('');if(showUpload)html+='<div class="pfp-upload-opt" id="'+containerId+'-pfp-opt" onclick="document.getElementById(\''+containerId+'-pfp-input\').click()"><input type="file" id="'+containerId+'-pfp-input" accept="image/*" style="display:none" onchange="handlePfpUpload(this,\''+containerId+'\')"><span></span><span class="pfp-label">Photo</span></div>';container.innerHTML=html;container.onclick=function(e){var o=e.target.closest('.av-opt');if(!o)return;container.querySelectorAll('.av-opt,.pfp-upload-opt').forEach(function(el){el.classList.remove('sel')});o.classList.add('sel');if(onSelect)onSelect('emoji',+o.dataset.idx,null);SFX.select()}}

function handlePfpUpload(input,containerId){var file=input.files[0];if(!file)return;if(!file.type.startsWith('image/')){showToast('Please select an image');SFX.error();return}if(file.size>5*1024*1024){showToast('Image too large (max 5MB)');SFX.error();return}var reader=new FileReader();reader.onload=function(e){var dataUrl=e.target.result;var img=new Image();img.onload=function(){var canvas=document.createElement('canvas'),maxSz=200,w=img.width,h=img.height;if(w>h){h=h*(maxSz/w);w=maxSz}else{w=w*(maxSz/h);h=maxSz}canvas.width=w;canvas.height=h;canvas.getContext('2d').drawImage(img,0,0,w,h);var resized=canvas.toDataURL('image/jpeg',0.8);var opt=document.getElementById(containerId+'-pfp-opt');if(opt){opt.innerHTML='<img src="'+resized+'" class="pfp-preview"><input type="file" id="'+containerId+'-pfp-input" accept="image/*" style="display:none" onchange="handlePfpUpload(this,\''+containerId+'\')">';var container=document.getElementById(containerId);container.querySelectorAll('.av-opt,.pfp-upload-opt').forEach(function(el){el.classList.remove('sel')});opt.classList.add('sel')}if(containerId==='av-grid'){pfpMode='photo';pfpTempData=resized}else if(containerId==='pfp-av-grid'){pfpTempMode='photo';pfpTempData=resized}SFX.correct()};img.src=dataUrl};reader.readAsDataURL(file)}

function initSetup(){pfpMode='emoji';pfpTempData=null;buildAvatarGrid('av-grid',true,function(type,idx){pfpMode='emoji';selectedAvatarIdx=idx;pfpTempData=null});var firstAv=document.querySelector('#av-grid .av-opt');if(firstAv)firstAv.classList.add('sel');var gg=document.getElementById('gr-grid');gg.innerHTML=GRADES.map(function(g){return'<div class="grade-opt" data-g="'+g+'">'+g+'</div>'}).join('');gg.onclick=function(e){var o=e.target.closest('.grade-opt');if(!o)return;selGr=o.dataset.g;gg.querySelectorAll('.grade-opt').forEach(function(el){el.classList.remove('sel')});o.classList.add('sel');SFX.select()}}

function saveProfile(){var n=document.getElementById('inp-name').value.trim();if(!n){showToast('Please enter your name');SFX.error();return}if(!selGr){showToast('Pick your grade level');SFX.error();return}S.profile={name:n,avatar:AVATARS[selectedAvatarIdx],grade:selGr};if(pfpMode==='photo'&&pfpTempData)S.pfpData=pfpTempData;else S.pfpData=null;save();unlock('first_profile');startQuiz()}

function showPfpChangeModal(){pfpTempMode=S.pfpData?'photo':'emoji';pfpTempIdx=S.profile?AVATARS.indexOf(S.profile.avatar):0;if(pfpTempIdx<0)pfpTempIdx=0;pfpTempData=S.pfpData||null;buildAvatarGrid('pfp-av-grid',true,function(type,idx){pfpTempMode='emoji';pfpTempIdx=idx;pfpTempData=null});setTimeout(function(){var grid=document.getElementById('pfp-av-grid');if(S.pfpData){var pfpOpt=document.getElementById('pfp-av-grid-pfp-opt');if(pfpOpt){pfpOpt.innerHTML='<img src="'+S.pfpData+'" class="pfp-preview"><input type="file" id="pfp-av-grid-pfp-input" accept="image/*" style="display:none" onchange="handlePfpUpload(this,\'pfp-av-grid\')">';pfpOpt.classList.add('sel')}}else{var avOpts=grid.querySelectorAll('.av-opt');if(avOpts[pfpTempIdx])avOpts[pfpTempIdx].classList.add('sel')}},50);document.getElementById('pfp-modal').classList.add('show');SFX.whoosh()}

function hidePfpModal(){document.getElementById('pfp-modal').classList.remove('show')}
function confirmPfpChange(){if(pfpTempMode==='photo'&&pfpTempData){S.pfpData=pfpTempData;S.profile.avatar=AVATARS[0]}else{S.pfpData=null;S.profile.avatar=AVATARS[pfpTempIdx]}save();hidePfpModal();renderHome();showToast('Profile updated!');SFX.success()}
function loadExisting(){if(load()&&S.profile){renderHome();navigateTo('screen-home')}else{showToast('No saved profile');SFX.error()}}

function addCookies(n){S.cookies=(S.cookies||0)+n;save();updateCookieDisplay();var badge=document.getElementById('cookie-display');if(badge){badge.classList.remove('cookie-pop');void badge.offsetWidth;badge.classList.add('cookie-pop');setTimeout(function(){badge.classList.remove('cookie-pop')},400)}}
function updateCookieDisplay(){var el=document.getElementById('cookie-count');if(el)el.textContent=S.cookies||0}

function startQuiz(){S.quizAnswers={};quizQ=0;navigateTo('screen-quiz');renderQ()}
function renderQ(){var q=QUESTIONS[quizQ];document.getElementById('q-prog').style.width=((quizQ+1)/QUESTIONS.length*100)+'%';document.getElementById('q-num').textContent='Q'+(quizQ+1)+' / '+QUESTIONS.length;document.getElementById('q-hint').textContent='Results at Q'+QUESTIONS.length;var sel=S.quizAnswers[quizQ];document.getElementById('q-body').innerHTML='<div class="quiz-scenario"><div class="scenario-label">Scenario</div><div style="font-size:15px;font-weight:700;color:var(--text);line-height:1.5;">'+q.scenario+'</div></div><div class="quiz-qtext">'+q.q+'</div><div class="quiz-opts">'+q.opts.map(function(o,i){return'<div class="quiz-opt '+(sel===i?'sel':'')+'" onclick="pickQ('+i+',this)"><div class="quiz-dot">'+(sel===i?'':'')+'</div><span>'+String.fromCharCode(65+i)+'. '+o.label+'</span></div>'}).join('')+'</div>';document.getElementById('q-prev').style.opacity=quizQ===0?'0.35':'1';document.getElementById('q-next').textContent=quizQ===QUESTIONS.length-1?'See My Results':'Next'}
function pickQ(v,el){S.quizAnswers[quizQ]=v;document.querySelectorAll('.quiz-opt').forEach(function(o){o.classList.remove('sel');o.querySelector('.quiz-dot').textContent=''});el.classList.add('sel');el.querySelector('.quiz-dot').textContent='';SFX.select()}
function qNext(){if(S.quizAnswers[quizQ]===undefined){showToast('Select an answer');SFX.error();return}if(quizQ<QUESTIONS.length-1){quizQ++;renderQ()}else computeResults()}
function qPrev(){if(quizQ>0){quizQ--;renderQ()}}

function computeResults(){var sc={};TECHNIQUES.forEach(function(t){sc[t.id]=0});QUESTIONS.forEach(function(q,i){var ai=S.quizAnswers[i];if(ai===undefined)return;var o=q.opts[ai];if(o&&o.w)Object.keys(o.w).forEach(function(id){if(sc[id]!==undefined)sc[id]+=o.w[id]})});var max=Math.max.apply(null,Object.values(sc).concat([1]));var norm={};Object.keys(sc).forEach(function(k){norm[k]=Math.round(sc[k]/max*100)});S.scores=norm;S.topTech=Object.keys(norm).sort(function(a,b){return norm[b]-norm[a]})[0];save();unlock('quiz_complete');renderResults();navigateTo('screen-results');SFX.success();setTimeout(function(){burst(window.innerWidth/2,window.innerHeight/2)},300)}

function renderResults(){var sorted=Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]});var tm={};TECHNIQUES.forEach(function(t){tm[t.id]=t});var medals=['','',''];document.getElementById('r-sub').textContent='Hi '+S.profile.name+'! Here are your results:';document.getElementById('r-body').innerHTML=sorted.map(function(id,i){var t=tm[id],pct=S.scores[id];if(!t)return'';return'<div class="result-card" style="background:'+t.soft+';border-color:'+t.cval+'40;color:'+t.cval+';" onclick="openTech(\''+id+'\')"><div class="result-rank">'+(medals[i]||'#'+(i+1))+'</div><div class="result-info"><h4>'+t.icon+' '+t.name+'</h4><p>'+t.desc+'</p></div><div class="result-pct-wrap"><div class="result-pct">'+pct+'%</div><div class="result-pct-label">match</div></div><div class="result-bar-bg"><div class="result-bar-fill" style="background:'+t.cval+';width:0%;" data-w="'+pct+'"></div></div></div>'}).join('');setTimeout(function(){document.querySelectorAll('.result-bar-fill').forEach(function(b){b.style.width=b.dataset.w+'%'})},200)}

function goToHome(){renderHome();navigateTo('screen-home')}

function renderHome(){if(!S.profile)return;document.getElementById('g-name').textContent=S.profile.name;var homeAvEl=document.getElementById('home-av');if(S.pfpData)homeAvEl.innerHTML='<img src="'+S.pfpData+'" class="home-pfp" onclick="SFX.tap();showPfpChangeModal()">';else homeAvEl.innerHTML='<span style="font-size:24px;cursor:pointer;" onclick="SFX.tap();showPfpChangeModal()">'+S.profile.avatar+'</span>';var h=new Date().getHours();document.getElementById('greeting-time').textContent=(h<12?'Good morning,':h<17?'Good afternoon,':'Good evening,');updateCookieDisplay();renderPetLevelCard();renderStreakDays();var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]}):[];var techHTML=TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1,pct=S.scores[t.id]||0;return'<div class="tc" onclick="SFX.tap();openTech(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div>'+(rank===1?'<div class="tc-badge tc-best">Best</div>':(rank<=3?'<div class="tc-badge tc-match">#'+rank+'</div>':''))+'<span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div>'+(pct?'<div style="margin-top:8px;height:5px;background:var(--surface3);border-radius:3px;overflow:hidden;"><div style="height:100%;width:'+pct+'%;background:'+t.cval+';border-radius:3px;transition:width 1s;"></div></div>':'')+'</div>'}).join('');var testHTML=TEST_METHODS.map(function(t){return'<div class="tc" onclick="SFX.tap();openTestMethod(\''+t.id+'\')"><div style="position:absolute;top:0;left:0;right:0;height:4px;border-radius:var(--r-lg) var(--r-lg) 0 0;background:'+t.cval+';"></div><span class="tc-icon">'+t.icon+'</span><div class="tc-name">'+t.name+'</div><div class="tc-desc">'+t.desc+'</div></div>'}).join('');document.getElementById('home-tech-grid').innerHTML=techHTML+'<div class="section-label" style="margin-top:16px;grid-column:1/-1;">Test Yourself</div>'+testHTML;document.querySelector('#daily-tip p').textContent=TIPS[new Date().getDate()%TIPS.length];applyTheme();renderCapyWidget()}

function renderPetLevelCard(){initCapyState();var lvInfo=getCapyLevel();var fed=S.capy?S.capy.totalFed:0;var thresholds=[0,10,25,50,100];var curThresh=thresholds[lvInfo.lv-1]||0;var nextThresh=thresholds[lvInfo.lv]||thresholds[thresholds.length-1];var progress=lvInfo.lv>=5?100:Math.min(100,Math.round((fed-curThresh)/(nextThresh-curThresh)*100));var emojis=['','','','',''];document.getElementById('pet-lv-emoji').textContent=emojis[lvInfo.lv-1]||'';document.getElementById('pet-lv-name').textContent=(S.capy?S.capy.name:'Cappy')+'  Lv '+lvInfo.lv+' '+lvInfo.title;document.getElementById('pet-lv-progress').textContent=lvInfo.lv>=5?'MAX':fed+'/'+nextThresh+' feeds';document.getElementById('pet-lv-bar').style.width=progress+'%'}

function renderStreakDays(){var days=['Su','Mo','Tu','We','Th','Fr','Sa'],today=new Date().getDay();document.getElementById('streak-days').innerHTML=days.map(function(d,i){var isT=i===today;var isD=(S.sessions||[]).some(function(s){var sd=new Date(s.date);return sd.getDay()===i&&(Date.now()-sd)<7*864e5});return'<div class="sday '+(isT?'today':'')+' '+(isD?'done':'')+'"><span>'+d+'</span>'+(isD||isT?'<div class="sday-dot"></div>':'')+'</div>'}).join('');document.getElementById('streak-n').textContent=S.streak||0}

function renderStudyList(){var sorted=S.scores?Object.keys(S.scores).sort(function(a,b){return S.scores[b]-S.scores[a]}):[];var savedCount=(S.savedReviews||[]).length;var techListHTML=TECHNIQUES.map(function(t){var rank=sorted.indexOf(t.id)+1,pct=S.scores[t.id]||0;return'<div class="tech-list-item" onclick="SFX.tap();openTech(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div>'+(pct?'<div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">'+(rank===1?'Best':'#'+rank)+' '+pct+'%</div>':'')+'</div><span style="color:var(--text3);font-size:20px;"></span></div>'}).join('');var testListHTML=TEST_METHODS.map(function(t){return'<div class="tech-list-item" onclick="SFX.tap();openTestMethod(\''+t.id+'\')"><span class="tli-icon">'+t.icon+'</span><div class="tli-info"><div class="tli-name">'+t.name+'</div><div class="tli-desc">'+t.desc+'</div><div class="tli-match" style="background:'+t.soft+';color:'+t.cval+';">Test</div></div><span style="color:var(--text3);font-size:20px;"></span></div>'}).join('');document.getElementById('study-list-body').innerHTML='<div class="section-label">Study Techniques</div>'+techListHTML+'<div class="section-label" style="margin-top:20px;">Test Yourself</div>'+testListHTML+'<div class="section-label" style="margin-top:20px;">My Reviews</div><div class="tech-list-item" onclick="SFX.tap();openSavedReviews()"><span class="tli-icon"></span><div class="tli-info"><div class="tli-name">Saved Reviews</div><div class="tli-desc">All your saved study sessions</div><div class="tli-match" style="background:var(--purple-g);color:var(--purple);">'+savedCount+' saved</div></div><span style="color:var(--text3);font-size:20px;"></span></div>'}

var fcDeckIdx=null,fcCardIdx=0,fcFlipped=false,newDeckColor=DECK_COLORS[0];
function initFC(){switchFcTab('decks',document.querySelector('.fc-tab'));renderFCDecks();renderFCCreate();renderFCAI()}
function switchFcTab(tab,el){document.querySelectorAll('.fc-tab').forEach(function(t){t.classList.remove('active')});document.querySelectorAll('.fc-section').forEach(function(s){s.classList.remove('active')});var sec=document.getElementById('fc-'+tab);if(sec)sec.classList.add('active');if(el)el.classList.add('active');else{var tabs=document.querySelectorAll('.fc-tab');var idx=['decks','create','ai','study'].indexOf(tab);if(idx>=0&&idx<3&&tabs[idx])tabs[idx].classList.add('active')}}

function renderFCDecks(){var el=document.getElementById('fc-decks');if(!S.decks||!S.decks.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:16px;font-weight:800;margin-bottom:6px;color:var(--text);">No decks yet!</div><div style="font-size:13px;">Create or use AI Gen.</div></div>';return}el.innerHTML=S.decks.map(function(d,i){return'<div class="deck-card" onclick="SFX.tap();openDeck('+i+')"><div class="deck-dot" style="background:'+d.color+';"></div><div class="deck-info"><h4>'+esc(d.name)+'</h4><p>'+(d.subject||'General')+'  '+d.cards.length+' cards</p></div><div class="deck-count">'+d.cards.length+'</div><button onclick="event.stopPropagation();deleteDeck('+i+')" style="background:none;border:none;color:var(--text3);cursor:pointer;padding:4px;font-size:14px;"></button></div>'}).join('')}

function renderFCCreate(){document.getElementById('fc-create').innerHTML='<div class="create-deck-form"><h4> New Deck</h4><div class="form-group"><label class="form-label">Deck Name</label><input class="form-input" id="new-deck-name" placeholder="e.g. Chapter 3"></div><div class="form-group"><label class="form-label">Subject</label><input class="form-input" id="new-deck-subj" placeholder="e.g. Biology"></div><div class="form-group"><label class="form-label">Color</label><div class="color-picker">'+DECK_COLORS.map(function(c){return'<div class="color-swatch '+(c===newDeckColor?'sel':'')+'" style="background:'+c+';" onclick="newDeckColor=\''+c+'\';document.querySelectorAll(\'.color-swatch\').forEach(function(s){s.classList.remove(\'sel\')});this.classList.add(\'sel\');SFX.pop()"></div>'}).join('')+'</div></div><button class="btn btn-primary btn-full" onclick="createDeck()">Create Deck</button></div>'}

function createDeck(){var n=document.getElementById('new-deck-name').value.trim(),s=document.getElementById('new-deck-subj').value.trim();if(!n){showToast('Name your deck');SFX.error();return}if(!S.decks)S.decks=[];S.decks.push({name:n,subject:s,color:newDeckColor,cards:[]});save();if(S.decks.length>=5)unlock('five_decks');renderFCDecks();renderFCCreate();showToast('Deck created! +1 ');addXP(10);addCookies(1);switchFcTab('decks',null);SFX.correct()}
function deleteDeck(i){if(!confirm('Delete?'))return;S.decks.splice(i,1);save();renderFCDecks();SFX.erase()}
function openDeck(i){fcDeckIdx=i;fcCardIdx=0;fcFlipped=false;renderFCStudy();switchFcTab('study',null)}

function renderFCStudy(){var deck=S.decks[fcDeckIdx];if(!deck)return;var el=document.getElementById('fc-study');var card=deck.cards.length?deck.cards[fcCardIdx]:null;el.innerHTML='<div style="display:flex;align-items:center;margin-bottom:12px;"><button class="btn btn-ghost btn-sm" onclick="SFX.tap();switchFcTab(\'decks\',document.querySelector(\'.fc-tab\'))"> Back</button><span style="font-size:14px;font-weight:800;flex:1;text-align:center;">'+esc(deck.name)+'</span><span class="pill">'+deck.cards.length+'</span></div>'+(deck.cards.length?'<div class="fc-scene" onclick="flipCard()"><div class="fc-inner '+(fcFlipped?'flipped':'')+'" id="fc-inner"><div class="fc-face" style="border-color:'+deck.color+'40;"><div class="fc-face-label">QUESTION</div><div class="fc-face-text">'+esc(card.front)+'</div><div class="fc-face-hint">Tap to flip</div></div><div class="fc-face fc-back-face" style="border-color:'+deck.color+'60;"><div class="fc-face-label">ANSWER</div><div class="fc-face-text">'+esc(card.back)+'</div></div></div></div><div class="fc-rate-btns"><div class="fc-rate fc-again" onclick="rateCard(\'again\')">Again</div><div class="fc-rate fc-hard" onclick="rateCard(\'hard\')">Hard</div><div class="fc-rate fc-good" onclick="rateCard(\'good\')">Easy</div></div><div style="text-align:center;font-size:12px;font-weight:700;color:var(--text3);margin-bottom:10px;">Card '+(fcCardIdx+1)+'/'+deck.cards.length+'</div><div style="text-align:center;margin-bottom:16px;"><button class="btn btn-secondary btn-sm" onclick="SFX.tap();saveFCSession()"> Save</button></div>':'<div style="text-align:center;padding:40px 0;color:var(--text3);"><div style="font-size:52px;margin-bottom:14px;"></div><div style="font-size:15px;font-weight:800;color:var(--text);">No cards yet!</div></div>')+'<div class="create-deck-form"><h4> Add Card</h4><textarea class="form-input" id="fc-front" placeholder="Question" style="margin-bottom:8px;min-height:70px;"></textarea><textarea class="form-input" id="fc-back" placeholder="Answer" style="margin-bottom:10px;min-height:70px;"></textarea><button class="btn btn-primary btn-full" onclick="addCard()">Add Card</button></div>'}

function saveFCSession(){var deck=S.decks[fcDeckIdx];if(!deck||!deck.cards.length)return;var content='Deck: '+deck.name+'\nCards:\n'+deck.cards.map(function(c,i){return(i+1)+'. Q: '+c.front+'\n   A: '+c.back}).join('\n');saveReviewItem('flashcards','Flashcards: '+deck.name,content);addXP(5);addCookies(1)}
function flipCard(){fcFlipped=!fcFlipped;var el=document.getElementById('fc-inner');if(el){el.classList.toggle('flipped',fcFlipped);SFX.flip()}}
function rateCard(r){var d=S.decks[fcDeckIdx];if(!d||!d.cards.length)return;fcFlipped=false;if(r!=='again')fcCardIdx=(fcCardIdx+1)%d.cards.length;addXP(r==='good'?10:5);if(r==='good')addCookies(1);unlock('first_fc');r==='good'?SFX.correct():SFX.tap();renderFCStudy()}
function addCard(){var f=document.getElementById('fc-front').value.trim(),b=document.getElementById('fc-back').value.trim();if(!f||!b){showToast('Fill both sides');SFX.error();return}S.decks[fcDeckIdx].cards.push({front:f,back:b});save();showToast('Card added!');SFX.correct();renderFCStudy()}

async function readPDFFile(file){try{var ab=await file.arrayBuffer();var pdf=await pdfjsLib.getDocument({data:ab}).promise;var t='';var maxPages=Math.min(pdf.numPages,50);for(var i=1;i<=maxPages;i++){try{var pg=await pdf.getPage(i);var c=await pg.getTextContent();var pageText='';var lastY=null;c.items.forEach(function(item){if(lastY!==null&&Math.abs(item.transform[5]-lastY)>5){pageText+='\n'}else if(lastY!==null&&item.str.length>0){pageText+=' '}pageText+=item.str;lastY=item.transform[5]});t+=pageText.trim()+'\n\n'}catch(e){}}t=t.replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n').replace(/  +/g,' ').trim();return t}catch(e){throw new Error('Could not read PDF.')}}

async function readImageOCR(file){try{var r=await Tesseract.recognize(file,'eng',{logger:function(){},tessedit_pageseg_mode:'6',preserve_interword_spaces:'1'});var text=r.data.text;text=text.replace(/[|]/g,'I').replace(/\s+\n/g,'\n').replace(/\n{3,}/g,'\n\n').replace(/  +/g,' ').replace(/[^\x20-\x7E\n\u00C0-\u024F\u1E00-\u1EFF]/g,'').trim();return text}catch(e){throw new Error('OCR failed.')}}

async function preprocessImage(file){return new Promise(function(resolve){var img=new Image();img.onload=function(){var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');var maxDim=2000;var w=img.width,h=img.height;if(w>maxDim||h>maxDim){var scale=maxDim/Math.max(w,h);w=Math.round(w*scale);h=Math.round(h*scale)}canvas.width=w;canvas.height=h;ctx.drawImage(img,0,0,w,h);var imageData=ctx.getImageData(0,0,w,h);var data=imageData.data;for(var i=0;i<data.length;i+=4){var gray=0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];var val=gray>128?255:0;data[i]=val;data[i+1]=val;data[i+2]=val}ctx.putImageData(imageData,0,0);canvas.toBlob(function(blob){resolve(blob)},'image/png')};img.src=URL.createObjectURL(file)})}

async function handleFile(file){if(!file)return;var sa=document.getElementById('upload-status-area'),ti=document.getElementById('ai-text-input');if(file.type==='text/plain'){var r=new FileReader();r.onload=function(e){ti.value=e.target.result;sa.innerHTML='<div class="upload-status upload-success"> Text loaded ('+e.target.result.length+' chars)</div>';SFX.correct()};r.readAsText(file)}else if(file.type.startsWith('image/')){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Preprocessing & running OCR...</div>';try{var processed=await preprocessImage(file);var txt=await readImageOCR(processed);if(txt.length>10){ti.value=txt;sa.innerHTML='<div class="upload-status upload-success"> Extracted '+txt.length+' chars</div>';SFX.success()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);"> Little text found  try clearer image</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">OCR failed  try another image</div>';SFX.error()}}else if(file.type==='application/pdf'){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Reading PDF...</div>';try{var pt=await readPDFFile(file);if(pt.length>20){ti.value=pt;sa.innerHTML='<div class="upload-status upload-success"> PDF loaded ('+pt.length+' chars)</div>';SFX.success()}else{sa.innerHTML='<div class="upload-status" style="background:var(--yellow-soft);color:var(--orange);"> PDF has little extractable text</div>';SFX.error()}}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">PDF failed</div>';SFX.error()}}else{showToast('Unsupported file type');SFX.error()}}

async function handleTestFile(file,type){if(!file)return;var sa=document.getElementById(type+'-upload-status'),ti=document.getElementById(type+'-text-input');if(file.type==='text/plain'){var r=new FileReader();r.onload=function(e){ti.value=e.target.result;sa.innerHTML='<div class="upload-status upload-success"> Loaded ('+e.target.result.length+' chars)</div>';SFX.correct()};r.readAsText(file)}else if(file.type.startsWith('image/')){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> OCR processing...</div>';try{var processed=await preprocessImage(file);var txt=await readImageOCR(processed);ti.value=txt;sa.innerHTML='<div class="upload-status upload-success"> Extracted '+txt.length+' chars</div>';SFX.success()}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">Failed</div>';SFX.error()}}else if(file.type==='application/pdf'){sa.innerHTML='<div class="upload-status upload-loading"><div class="spinner"></div> Reading PDF...</div>';try{var pt=await readPDFFile(file);ti.value=pt;sa.innerHTML='<div class="upload-status upload-success"> PDF loaded ('+pt.length+' chars)</div>';SFX.success()}catch(e){sa.innerHTML='<div class="upload-status" style="background:var(--red-soft);color:var(--red);">Failed</div>';SFX.error()}}else{showToast('Unsupported');SFX.error()}}

function renderFCAI(){document.getElementById('fc-ai').innerHTML='<div class="ai-gen-box"><h4> Smart Generator</h4><p>Upload or paste text to create flashcards.</p><div class="upload-area" onclick="document.getElementById(\'file-input\').click()" ondragover="event.preventDefault();this.classList.add(\'drag\')" ondragleave="this.classList.remove(\'drag\')" ondrop="event.preventDefault();this.classList.remove(\'drag\');if(event.dataTransfer.files[0])handleFile(event.dataTransfer.files[0])"><input type="file" id="file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleFile(this.files[0])"><span class="upload-icon"></span><div class="upload-text">Tap to upload</div><div class="upload-hint">Images, PDF, Text</div></div><div id="upload-status-area"></div><textarea class="form-input" id="ai-text-input" placeholder="Paste notes here..." style="min-height:120px;margin:10px 0;"></textarea><input class="form-input" id="ai-deck-name" placeholder="Deck name" style="margin-bottom:10px;"><button class="btn btn-primary btn-full" onclick="generateCards()"> Generate</button></div><div id="ai-preview"></div>'}

function generateCards(){var text=document.getElementById('ai-text-input').value.trim(),dn=document.getElementById('ai-deck-name').value.trim();if(!text||text.length<15){showToast('Add more text');SFX.error();return}if(!dn){showToast('Name deck');SFX.error();return}var cards=smartGenCards(text);if(!cards.length){showToast('Could not extract');SFX.error();return}var color=DECK_COLORS[Math.floor(Math.random()*DECK_COLORS.length)];if(!S.decks)S.decks=[];S.decks.push({name:dn,subject:'AI Generated',color:color,cards:cards});save();addXP(20);addCookies(2);SFX.success();if(S.decks.length>=5)unlock('five_decks');burst(window.innerWidth/2,300);document.getElementById('ai-preview').innerHTML='<div style="background:var(--green-soft);border:1.5px solid rgba(16,185,129,0.3);border-radius:var(--r-lg);padding:18px;text-align:center;"><div style="font-size:36px;margin-bottom:8px;"></div><div style="font-size:16px;font-weight:800;">'+cards.length+' cards! +2 </div><button class="btn btn-primary" style="margin-top:10px;" onclick="SFX.tap();openDeck('+(S.decks.length-1)+');switchFcTab(\'study\',null)">Study Now</button></div>'}

function smartGenCards(text){var cards=[],lines=text.split('\n').map(function(l){return l.trim()}).filter(function(l){return l.length>3}),isFil=detectFil(text);lines.forEach(function(ln){var m=ln.match(/^([A-Za-z\u00C0-\u024F][^:;\u2013\u2014\n]{1,60}?)\s*[:;\u2013\u2014]\s*(.{8,300})$/);if(m&&!hasSim(cards,m[1].trim()))cards.push({front:(isFil?'Ano ang ':'What is ')+m[1].trim()+'?',back:cap(m[2].trim())})});lines.forEach(function(ln){var m=ln.match(/^\d+[\.\)]\s*([^:;\u2013\u2014]{2,50})\s*[:;\u2013\u2014]\s*(.{8,300})$/);if(m&&!hasSim(cards,m[1].trim()))cards.push({front:(isFil?'Ipaliwanag: ':'Define: ')+m[1].trim(),back:cap(m[2].trim())})});for(var i=0;i<lines.length-1;i++){if(lines[i].endsWith('?')&&lines[i].length>8&&lines[i+1].length>5&&!lines[i+1].endsWith('?')&&!hasSim(cards,lines[i])){cards.push({front:lines[i],back:cap(lines[i+1])});i++}}var sents=text.replace(/([.!;])\s+/g,'$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>20&&s.length<350&&!s.endsWith('?')});sents.forEach(function(s){if(cards.length>=35)return;var m=s.match(/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{1,40}?)\s+(is|are|was|were|refers to|means)\s+(.{8,250})$/i);if(m&&!hasSim(cards,m[2].trim()))cards.push({front:'What '+m[3].toLowerCase()+' '+m[2].trim()+'?',back:cap(m[2].trim()+' '+m[3].toLowerCase()+' '+m[4].trim())})});if(cards.length<8)sents.slice(0,15).forEach(function(s){if(cards.length>=35)return;var w=s.split(/\s+/);if(w.length<5)return;var cands=[];for(var j=2;j<w.length-1;j++){var ww=w[j].replace(/[.,;!?'"]/g,'');if(ww.length>4&&ww[0]===ww[0].toLowerCase()&&!/^(the|and|but|for|with|from|that|this|have|been|will|also|then|than|when|each|only)$/i.test(ww))cands.push({i:j,w:ww})}if(cands.length){var p=cands[Math.floor(Math.random()*cands.length)];if(!hasSim(cards,p.w))cards.push({front:'Fill in: '+w.map(function(x,k){return k===p.i?'_____':x}).join(' '),back:p.w})}});var seen={};return cards.filter(function(c){var k=(c.front+c.back).slice(0,80).toLowerCase();if(seen[k])return false;seen[k]=true;return true}).slice(0,35)}
function detectFil(t){var w=['ang','ng','sa','mga','ay','nang','para','ito','siya','dahil','kung','ano'],ct=0;w.forEach(function(x){var m=t.toLowerCase().match(new RegExp('\\b'+x+'\\b','gi'));if(m)ct+=m.length});return ct>5}
function hasSim(cards,t){var l=t.toLowerCase();return cards.some(function(c){return c.front.toLowerCase().indexOf(l)>=0})}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1)}

var blurtPhase='source',blurtSrc='',blurtTxt='',blurtTimerRaf=null,blurtLastFrame=0,blurtSecs=120,blurtReviewDur=2;
function adjustBlurtDur(amt){blurtReviewDur=Math.max(1,Math.min(60,blurtReviewDur+amt));renderBlurt();SFX.pop()}
function initBlurt(){blurtPhase='source';blurtSrc='';blurtTxt='';blurtReviewDur=2;renderBlurt()}
function renderBlurt(){var el=document.getElementById('blurt-body');if(blurtPhase==='source'){el.innerHTML='<div class="phase-badge" style="background:var(--blue-soft);color:var(--blue);">Step 1: Enter Source</div><textarea class="form-input" id="blurt-src" placeholder="Paste notes..." style="min-height:180px;margin-bottom:12px;">'+blurtSrc+'</textarea><div class="section-label">Timer Duration</div><div class="min-adjuster"><div class="min-adj-btn minus" onclick="adjustBlurtDur(-10)">10</div><div class="min-adj-btn minus" onclick="adjustBlurtDur(-5)">5</div><div class="min-adj-btn minus" onclick="adjustBlurtDur(-1)">1</div><div class="min-display">'+blurtReviewDur+'<span style="font-size:16px;color:var(--text3);"> min</span></div><div class="min-adj-btn" onclick="adjustBlurtDur(1)">+1</div><div class="min-adj-btn" onclick="adjustBlurtDur(5)">+5</div><div class="min-adj-btn" onclick="adjustBlurtDur(10)">+10</div></div><div class="min-label">min: 1  max: 60</div><button class="btn btn-primary btn-full" style="margin-top:14px;" onclick="SFX.tap();startBlurt()">Start Blurting</button>'}else if(blurtPhase==='blurt'){el.innerHTML='<div class="phase-badge" style="background:var(--pink-soft);color:var(--pink);">Step 2: Write From Memory</div><div class="blurt-timer-big" id="bt-timer">'+blurtReviewDur+':00</div><textarea class="form-input" id="blurt-txt" placeholder="Write from memory..." style="min-height:210px;margin-bottom:12px;"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><button class="btn btn-secondary" onclick="SFX.erase();document.getElementById(\'blurt-txt\').value=\'\'">Clear</button><button class="btn btn-primary" onclick="SFX.tap();endBlurt()">Done</button></div>';startBlurtTimer()}else{el.innerHTML='<div class="phase-badge" style="background:var(--green-soft);color:var(--green);">Step 3: Compare</div><div class="compare-grid"><div class="compare-box"><h5>Source</h5>'+esc(blurtSrc)+'</div><div class="compare-box"><h5>Recall</h5>'+(blurtTxt?esc(blurtTxt):'<span style="opacity:0.4;">Nothing</span>')+'</div></div><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;"><button class="btn btn-primary" onclick="SFX.tap();initBlurt()">Again</button><button class="btn btn-secondary" onclick="SFX.tap();saveReviewItem(\'blurting\',\'Blurting\',\'Source:\\n\'+blurtSrc+\'\\n\\nRecall:\\n\'+blurtTxt)"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>'}}

function startBlurt(){blurtSrc=document.getElementById('blurt-src').value.trim();if(!blurtSrc){showToast('Add source');SFX.error();return}blurtTxt='';blurtPhase='blurt';blurtSecs=blurtReviewDur*60;renderBlurt()}

function startBlurtTimer(){if(blurtTimerRaf)cancelAnimationFrame(blurtTimerRaf);var startTime=performance.now();function tick(now){var elapsed=Math.floor((now-startTime)/1000);var remaining=blurtSecs-elapsed;if(remaining<=0){remaining=0;endBlurt();return}var m=Math.floor(remaining/60),s=remaining%60;var el=document.getElementById('bt-timer');if(el)el.textContent=m+':'+String(s).padStart(2,'0');blurtTimerRaf=requestAnimationFrame(tick)}blurtTimerRaf=requestAnimationFrame(tick)}

function endBlurt(){if(blurtTimerRaf)cancelAnimationFrame(blurtTimerRaf);blurtTimerRaf=null;var ta=document.getElementById('blurt-txt');if(ta)blurtTxt=ta.value.trim();blurtPhase='compare';S.blurtCt=(S.blurtCt||0)+1;addXP(15);addCookies(2);logSession('blurting');unlock('first_blurt');if(S.blurtCt>=10)unlock('blurt_10');save();SFX.correct();renderBlurt()}

function initCornell(){document.getElementById('cornell-body').innerHTML='<div class="cornell-grid"><div><div class="cornell-lbl">Questions</div><textarea class="form-input" id="cn-q" placeholder="What causes...?" style="min-height:200px;"></textarea></div><div><div class="cornell-lbl">Notes</div><textarea class="form-input" id="cn-n" placeholder="Notes..." style="min-height:200px;"></textarea></div></div><div style="margin-top:10px;"><div class="cornell-lbl">Summary</div><textarea class="form-input" id="cn-s" placeholder="Key takeaways..." style="min-height:70px;"></textarea></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;"><button class="btn btn-primary" onclick="SFX.tap();addXP(10);addCookies(1);logSession(\'question\');SFX.correct();showToast(\'Saved! +1 \');saveCornellReview()"> Save</button><button class="btn btn-secondary" onclick="SFX.tap();switchNav(\'home\')">Done</button></div>'}

function saveCornellReview(){var q=document.getElementById('cn-q'),n=document.getElementById('cn-n'),s=document.getElementById('cn-s');saveReviewItem('question','Cornell Notes','Questions:\n'+(q?q.value:'')+'\n\nNotes:\n'+(n?n.value:'')+'\n\nSummary:\n'+(s?s.value:''))}

var feynStep=0;
function initFeynman(){feynStep=0;renderFeynman()}
function renderFeynman(){var steps=['Concept','Explain','Gaps','Simplify'];var stepHTML=['<textarea class="form-input" id="feyn-concept" placeholder="Concept name" style="margin-bottom:10px;"></textarea><textarea class="form-input" id="feyn-know" placeholder="What you know..." style="min-height:180px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=1;renderFeynman()">Next</button>','<textarea class="form-input" id="feyn-explain" placeholder="Explain simply..." style="min-height:240px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=2;renderFeynman()">Next</button>','<textarea class="form-input" id="feyn-gaps" placeholder="Where stuck..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();feynStep=3;renderFeynman()">Next</button>','<textarea class="form-input" id="feyn-simple" placeholder="Final version..." style="min-height:200px;margin-bottom:12px;"></textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();saveFeynman()">Complete!</button>'];document.getElementById('feynman-body').innerHTML='<div class="feynman-steps">'+steps.map(function(s,i){return'<div class="feynman-step '+(i===feynStep?'active':'')+'">'+(i+1)+'. '+s+'</div>'}).join('')+'</div>'+stepHTML[feynStep]}
function saveFeynman(){S.feynmanCt=(S.feynmanCt||0)+1;addXP(20);addCookies(2);logSession('feynman');if(S.feynmanCt>=5)unlock('feynman_5');saveReviewItem('feynman','Feynman Session','Completed');save();SFX.success();showToast('Done! +2 ');feynStep=0;renderFeynman()}

var rrrPhase='read',_rS='',_rR='';
function initRRR(){rrrPhase='read';_rS='';_rR='';renderRRR()}
function renderRRR(){var el=document.getElementById('rrr-body');var ph={read:'<textarea class="form-input" id="rrr-src" placeholder="Paste material..." style="min-height:200px;margin-bottom:12px;">'+_rS+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rS=document.getElementById(\'rrr-src\').value;rrrPhase=\'recite\';renderRRR()">Recite </button>',recite:'<div class="compare-box" style="margin-bottom:10px;">Source hidden!</div><textarea class="form-input" id="rrr-rec" placeholder="From memory..." style="min-height:200px;margin-bottom:12px;">'+_rR+'</textarea><button class="btn btn-primary btn-full" onclick="SFX.tap();_rR=document.getElementById(\'rrr-rec\').value;rrrPhase=\'review\';renderRRR()">Review </button>',review:'<div class="compare-grid"><div class="compare-box"><h5>Original</h5>'+esc(_rS)+'</div><div class="compare-box"><h5>Recall</h5>'+esc(_rR)+'</div></div><button class="btn btn-primary btn-full" onclick="SFX.tap();addXP(15);addCookies(1);logSession(\'rrr\');save();SFX.success();showToast(\'Done! +1 \');saveReviewItem(\'rrr\',\'RRR\',\'Done\');rrrPhase=\'read\';renderRRR()">Done</button>'};el.innerHTML='<div class="rrr-btns"><div class="rrr-btn '+(rrrPhase==='read'?'active':'')+'">Read</div><div class="rrr-btn '+(rrrPhase==='recite'?'active':'')+'">Recite</div><div class="rrr-btn '+(rrrPhase==='review'?'active':'')+'">Review</div></div>'+(ph[rrrPhase]||'')}

var wbCtx=null,wbDrawing=false,wbColor='#a78bfa',wbSize=4,wbTool='pen',wbBg='#f5f0ff',wbHistory=[];
function initWB(){wbBg=currentTheme==='dark'?'#16132a':'#f5f0ff';wbHistory=[];renderWBToolbar();var c=document.getElementById('wbCanvas'),w=c.parentElement;var nc=c.cloneNode(false);c.parentNode.replaceChild(nc,c);var cv=document.getElementById('wbCanvas');cv.width=w.clientWidth||380;cv.height=w.clientHeight||400;wbCtx=cv.getContext('2d');wbCtx.lineCap='round';wbCtx.lineJoin='round';wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,cv.width,cv.height);wbSaveState();var lp=null;function gXY(e){var r=cv.getBoundingClientRect(),s=e.touches?e.touches[0]:e;return{x:(s.clientX-r.left)*(cv.width/r.width),y:(s.clientY-r.top)*(cv.height/r.height)}}function st(e){e.preventDefault();wbDrawing=true;lp=gXY(e)}function mv(e){e.preventDefault();if(!wbDrawing)return;var p=gXY(e);wbCtx.globalCompositeOperation='source-over';if(wbTool==='eraser'){wbCtx.strokeStyle=wbBg;wbCtx.lineWidth=wbSize*5}else{wbCtx.strokeStyle=wbColor;wbCtx.lineWidth=wbSize}wbCtx.beginPath();wbCtx.moveTo(lp.x,lp.y);wbCtx.lineTo(p.x,p.y);wbCtx.stroke();lp=p}function en(e){e.preventDefault();if(wbDrawing)wbSaveState();wbDrawing=false;lp=null}cv.addEventListener('mousedown',st);cv.addEventListener('mousemove',mv);cv.addEventListener('mouseup',en);cv.addEventListener('mouseleave',en);cv.addEventListener('touchstart',st,{passive:false});cv.addEventListener('touchmove',mv,{passive:false});cv.addEventListener('touchend',en,{passive:false})}
function wbSaveState(){var cv=document.getElementById('wbCanvas');if(cv&&wbCtx){wbHistory.push(cv.toDataURL());if(wbHistory.length>30)wbHistory.shift()}}
function wbUndo(){if(wbHistory.length<=1)return;wbHistory.pop();var last=wbHistory[wbHistory.length-1];if(last){var img=new Image();img.onload=function(){wbCtx.clearRect(0,0,document.getElementById('wbCanvas').width,document.getElementById('wbCanvas').height);wbCtx.drawImage(img,0,0)};img.src=last}}
function renderWBToolbar(){var cls=['#a78bfa','#f472b6','#34d399','#fbbf24','#60a5fa','#fb923c','#ffffff','#ef4444'];document.getElementById('wb-toolbar').innerHTML='<div class="wb-colors">'+cls.map(function(c){return'<div class="wb-color '+(c===wbColor?'sel':'')+'" style="background:'+c+';" onclick="wbColor=\''+c+'\';wbTool=\'pen\';renderWBToolbar();SFX.pop()"></div>'}).join('')+'</div><div class="wb-tools"><div class="wb-tool '+(wbTool==='pen'?'sel':'')+'" onclick="wbTool=\'pen\';renderWBToolbar()">Pen</div><div class="wb-tool '+(wbTool==='eraser'?'sel':'')+'" onclick="wbTool=\'eraser\';renderWBToolbar()">Erase</div></div>'}
function wbClear(){var c=document.getElementById('wbCanvas');if(wbCtx){wbCtx.fillStyle=wbBg;wbCtx.fillRect(0,0,c.width,c.height);wbSaveState()}SFX.erase()}
function wbSave(){addXP(10);addCookies(1);logSession('whiteboard');unlock('first_wb');saveReviewItem('whiteboard','Brain Dump','[Drawing saved]');save();SFX.success();showToast('Saved! +1 ');goBack()}

var diagNodes=[],diagEdges=[],diagColor='#8b5cf6',diagConnectMode=false,diagConnectFrom=null;
function initDiag(){diagNodes=[];diagEdges=[];diagConnectMode=false;diagConnectFrom=null;renderDiagToolbar();renderDiagCanvas()}
function renderDiagToolbar(){var cls=['#8b5cf6','#ec4899','#10b981','#fbbf24','#3b82f6','#f97316'];document.getElementById('diag-toolbar').innerHTML='<div style="display:flex;gap:5px;">'+cls.map(function(c){return'<div class="diag-color '+(c===diagColor?'sel':'')+'" style="background:'+c+';" onclick="diagColor=\''+c+'\';document.querySelectorAll(\'.diag-color\').forEach(function(e){e.classList.remove(\'sel\')});this.classList.add(\'sel\')"></div>'}).join('')+'</div><input class="diag-add-input" id="diag-node-input" placeholder="Node label..." onkeydown="if(event.key===\'Enter\'){event.preventDefault();addDiagNode()}"><button class="btn btn-primary btn-xs" onclick="addDiagNode()">Add</button>'}
function renderDiagCanvas(){var wrap=document.getElementById('diag-wrap'),nEl=document.getElementById('diag-nodes'),cv=document.getElementById('diagCanvas');cv.width=wrap.clientWidth||380;cv.height=wrap.clientHeight||300;var ctx=cv.getContext('2d');ctx.clearRect(0,0,cv.width,cv.height);ctx.lineWidth=2;diagEdges.forEach(function(e){if(diagNodes[e[0]]&&diagNodes[e[1]]){var a=diagNodes[e[0]],b=diagNodes[e[1]];ctx.strokeStyle=a.color+'60';ctx.beginPath();ctx.moveTo(a.x+40,a.y+20);ctx.lineTo(b.x+40,b.y+20);ctx.stroke()}});if(!diagNodes.length){nEl.innerHTML='<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:14px;font-weight:800;">Add your first node</div>';return}nEl.innerHTML=diagNodes.map(function(n,i){return'<div class="diag-node '+(i===0?'root':'')+'" id="dn'+i+'" style="left:'+n.x+'px;top:'+n.y+'px;background:'+n.color+'18;border-color:'+n.color+';color:'+n.color+';" onmousedown="diagDrag(event,'+i+')" ontouchstart="diagDragT(event,'+i+')">'+esc(n.label)+'<div class="diag-node-del" onclick="event.stopPropagation();delDN('+i+')"></div></div>'}).join('')}
function addDiagNode(){var inp=document.getElementById('diag-node-input'),label=(inp?inp.value:'').trim();if(!label){showToast('Type label');SFX.error();return}var wrap=document.getElementById('diag-wrap'),W=wrap.clientWidth||380,H=wrap.clientHeight||300;var x=!diagNodes.length?W/2-60:20+Math.random()*(W-140),y=!diagNodes.length?H/2-25:20+Math.random()*(H-80);if(diagNodes.length)diagEdges.push([0,diagNodes.length]);diagNodes.push({label:label,x:x,y:y,color:diagColor});if(inp)inp.value='';renderDiagCanvas();SFX.correct()}
function delDN(i){diagNodes.splice(i,1);diagEdges=diagEdges.filter(function(e){return e[0]!==i&&e[1]!==i}).map(function(e){return[e[0]>i?e[0]-1:e[0],e[1]>i?e[1]-1:e[1]]});renderDiagCanvas();SFX.erase()}
function diagDrag(e,i){if(diagConnectMode){finishConnect(i);return}e.preventDefault();var wrap=document.getElementById('diag-wrap'),r=wrap.getBoundingClientRect();var ox=e.clientX-r.left-diagNodes[i].x,oy=e.clientY-r.top-diagNodes[i].y;function mm(ev){diagNodes[i].x=Math.max(0,ev.clientX-r.left-ox);diagNodes[i].y=Math.max(0,ev.clientY-r.top-oy);var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px'}renderDiagCanvas()}function mu(){document.removeEventListener('mousemove',mm);document.removeEventListener('mouseup',mu)}document.addEventListener('mousemove',mm);document.addEventListener('mouseup',mu)}
function diagDragT(e,i){if(diagConnectMode){finishConnect(i);return}e.preventDefault();var wrap=document.getElementById('diag-wrap'),r=wrap.getBoundingClientRect(),t0=e.touches[0];var ox=t0.clientX-r.left-diagNodes[i].x,oy=t0.clientY-r.top-diagNodes[i].y;function tm(ev){ev.preventDefault();var t=ev.touches[0];diagNodes[i].x=Math.max(0,t.clientX-r.left-ox);diagNodes[i].y=Math.max(0,t.clientY-r.top-oy);var el=document.getElementById('dn'+i);if(el){el.style.left=diagNodes[i].x+'px';el.style.top=diagNodes[i].y+'px'}renderDiagCanvas()}function te(){document.removeEventListener('touchmove',tm);document.removeEventListener('touchend',te)}document.addEventListener('touchmove',tm,{passive:false});document.addEventListener('touchend',te)}
function finishConnect(i){if(diagConnectFrom===null){diagConnectFrom=i;showToast('Tap target')}else{if(diagConnectFrom!==i)diagEdges.push([diagConnectFrom,i]);diagConnectFrom=null;diagConnectMode=false;renderDiagCanvas();SFX.correct()}}
function diagConnect(){diagConnectMode=!diagConnectMode;diagConnectFrom=null;showToast(diagConnectMode?'Connect ON':'Connect OFF')}
function diagClear(){diagNodes=[];diagEdges=[];renderDiagCanvas();SFX.erase()}
function diagSave(){S.diagCt=(S.diagCt||0)+1;addXP(15);addCookies(1);logSession('diagram');if(S.diagCt>=5)unlock('diagram_5');saveReviewItem('diagram','Diagram','Nodes: '+diagNodes.length);save();SFX.success();showToast('Saved! +1 ')}

function renderSched(){var today=new Date(),days=['Su','Mo','Tu','We','Th','Fr','Sa'];document.getElementById('sched-week').innerHTML=days.map(function(d,i){var dt=new Date(today);dt.setDate(today.getDate()-today.getDay()+i);var ds=dt.toDateString(),isT=i===today.getDay();var has=(S.sessions||[]).some(function(s){return new Date(s.scheduledDate||s.date).toDateString()===ds});var isR=(S.restDays||[]).indexOf(ds)>=0;return'<div class="sched-day '+(isT?'today':'')+' '+(has?'has':'')+' '+(isR?'rest':'')+'"><div class="sched-dlbl">'+d+'</div><div class="sched-dnum">'+dt.getDate()+'</div></div>'}).join('')}

function renderSessList(){var tm=getTechMap(),el=document.getElementById('sess-list'),rc=(S.sessions||[]).slice().reverse().slice(0,12);if(!rc.length){el.innerHTML='<div style="text-align:center;padding:28px;color:var(--text3);font-size:14px;">No sessions yet!</div>';return}el.innerHTML=rc.map(function(s,idx){var t=tm[s.technique],realIdx=S.sessions.length-1-idx;return'<div class="sess-item"><div class="sess-dot" style="background:'+(t?t.cval:'var(--purple)')+'"></div><div class="sess-info"><h4>'+(t?t.icon+' ':'')+(s.subject||'Study')+'</h4><p>'+new Date(s.scheduledDate||s.date).toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})+'</p></div><div class="sess-time">'+(s.duration||0)+'m</div><button class="sess-del" onclick="event.stopPropagation();delSess('+realIdx+')"></button></div>'}).join('')}

function delSess(i){if(i>=0&&i<S.sessions.length){S.sessions.splice(i,1);save();renderSched();renderSessList();SFX.erase()}}

function showAddSessionModal(){tpH=2;tpM=0;tpAMPM='PM';updateTimeDisplay();var di=document.getElementById('modal-date');if(di)di.value=new Date().toISOString().split('T')[0];document.getElementById('modal-subject').value='';document.getElementById('session-modal').classList.add('show');SFX.whoosh()}
function hideAddSessionModal(){document.getElementById('session-modal').classList.remove('show')}
function confirmAddSession(){var subj=document.getElementById('modal-subject').value.trim(),tech=document.getElementById('modal-technique').value,dur=parseInt(document.getElementById('modal-duration').value)||30,dateVal=document.getElementById('modal-date').value;if(!subj){showToast('Enter subject');SFX.error();return}if(!dateVal){showToast('Pick date');SFX.error();return}var timeStr=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM;if(!S.sessions)S.sessions=[];S.sessions.push({technique:tech,subject:subj,date:new Date().toISOString(),scheduledDate:new Date(dateVal).toISOString(),duration:dur,time:timeStr});trackStreak();save();unlock('first_sched');hideAddSessionModal();renderSched();renderSessList();showToast('Added! +1 ');addXP(5);addCookies(1);SFX.correct()}

function updateTimeDisplay(){document.getElementById('modal-time-display').textContent=tpH+':'+String(tpM).padStart(2,'0')+' '+tpAMPM+'  Tap to change'}
function showTimePicker(){var presets=[{l:'6:00 AM',h:6,m:0,a:'AM'},{l:'8:00 AM',h:8,m:0,a:'AM'},{l:'2:00 PM',h:2,m:0,a:'PM'},{l:'6:00 PM',h:6,m:0,a:'PM'},{l:'8:00 PM',h:8,m:0,a:'PM'}];document.getElementById('time-presets').innerHTML=presets.map(function(p){return'<div class="time-preset" onclick="tpH='+p.h+';tpM='+p.m+';tpAMPM=\''+p.a+'\';updateTP();SFX.pop()">'+p.l+'</div>'}).join('');updateTP();document.getElementById('time-modal').classList.add('show')}
function hideTimePicker(){document.getElementById('time-modal').classList.remove('show')}
function updateTP(){document.getElementById('tp-hour').textContent=String(tpH).padStart(2,'0');document.getElementById('tp-min').textContent=String(tpM).padStart(2,'0');document.getElementById('tp-pm-am').classList.toggle('active',tpAMPM==='AM');document.getElementById('tp-pm-pm').classList.toggle('active',tpAMPM==='PM')}
function spinTime(type,dir){SFX.pop();if(type==='h'){tpH+=dir;if(tpH>12)tpH=1;if(tpH<1)tpH=12}else{tpM+=dir*5;if(tpM>=60)tpM=0;if(tpM<0)tpM=55}updateTP()}
function setAMPM(v){tpAMPM=v;updateTP()}
function confirmTimePick(){updateTimeDisplay();hideTimePicker();SFX.correct()}
function toggleRest(){if(!S.restDays)S.restDays=[];var td=new Date().toDateString(),idx=S.restDays.indexOf(td);if(idx>=0)S.restDays.splice(idx,1);else{S.restDays.push(td);if(S.restDays.length>=3)unlock('study_balance')}save();renderSched();SFX.select()}
function trackStreak(){var td=new Date().toDateString();if(S.lastStudy!==td){var y=new Date();y.setDate(y.getDate()-1);S.streak=S.lastStudy===y.toDateString()?(S.streak||0)+1:1;S.lastStudy=td;if(S.streak>=3)unlock('streak_3');if(S.streak>=7)unlock('streak_7')}}
function logSession(tech,subj,dur){if(!S.sessions)S.sessions=[];S.sessions.push({technique:tech,subject:subj||'',date:new Date().toISOString(),scheduledDate:new Date().toISOString(),duration:dur||25});trackStreak();S.mins=(S.mins||0)+(dur||25);if(S.mins>=600)unlock('hours_10');if(S.mins>=3000)unlock('hours_50');save()}

function adjustPomoDur(amt){reviewDuration=Math.max(1,Math.min(90,reviewDuration+amt));timerSecs=reviewDuration*60;updateTimerDisplay();renderPomoDurAdjuster();SFX.pop()}
function renderPomoDurAdjuster(){var el=document.getElementById('pomo-dur-adjuster');if(!el)return;if(timerOn){el.innerHTML='';return}el.innerHTML='<div class="min-adjuster"><div class="min-adj-btn minus" onclick="adjustPomoDur(-10)">10</div><div class="min-adj-btn minus" onclick="adjustPomoDur(-5)">5</div><div class="min-adj-btn minus" onclick="adjustPomoDur(-1)">1</div><div class="min-display">'+reviewDuration+'<span style="font-size:16px;color:var(--text3);"> min</span></div><div class="min-adj-btn" onclick="adjustPomoDur(1)">+1</div><div class="min-adj-btn" onclick="adjustPomoDur(5)">+5</div><div class="min-adj-btn" onclick="adjustPomoDur(10)">+10</div></div><div class="min-label">min: 1  max: 90</div>'}

// PERFORMANCE: RAF-based timer for 60fps
function toggleTimer(){if(timerOn){timerOn=false;if(timerRafId)cancelAnimationFrame(timerRafId);timerRafId=null;document.getElementById('timer-btn').textContent='Resume';renderPomoDurAdjuster()}else{timerOn=true;renderPomoDurAdjuster();document.getElementById('timer-btn').textContent='Pause';var lastTime=performance.now();function tick(now){if(!timerOn)return;var delta=now-lastTime;lastTime=now;if(delta<1000){timerSecs-=delta/1000}else{timerSecs-=1}if(timerSecs<=0){timerSecs=0;timerOn=false;pomoCt++;if(timerPhase==='focus'){logSession(S.topTech||'flashcards','Pomodoro',reviewDuration);addXP(25);addCookies(3);unlock('first_timer');SFX.alarm();timerPhase=pomoCt%4===0?'longbreak':'shortbreak';timerSecs=timerPhase==='longbreak'?900:300}else{timerPhase='focus';timerSecs=reviewDuration*60;SFX.alarm()}document.getElementById('timer-ring').className='timer-ring '+(timerPhase==='focus'?'focus-mode':'break-mode');document.getElementById('timer-phase').textContent=timerPhase==='focus'?'Focus Session':'Break';document.getElementById('timer-btn').textContent='Start';updateTimerDisplay();renderPomoDurAdjuster();return}updateTimerDisplay();timerRafId=requestAnimationFrame(tick)}timerRafId=requestAnimationFrame(tick)}SFX.tap()}

function resetTimer(){timerOn=false;if(timerRafId)cancelAnimationFrame(timerRafId);timerRafId=null;timerPhase='focus';pomoCt=0;timerSecs=reviewDuration*60;var btn=document.getElementById('timer-btn');if(btn)btn.textContent='Start';var phase=document.getElementById('timer-phase');if(phase)phase.textContent='Focus Session';var ring=document.getElementById('timer-ring');if(ring){ring.className='timer-ring';ring.textContent=Math.floor(timerSecs/60)+':'+String(Math.floor(timerSecs)%60).padStart(2,'0')}renderPomoDurAdjuster()}
function updateTimerDisplay(){var m=Math.floor(timerSecs/60),s=Math.floor(timerSecs%60);var el=document.getElementById('timer-ring');if(el)el.textContent=m+':'+String(s).padStart(2,'0')}

// IMPROVED QUESTION GENERATION ALGORITHM
function analyzeContentForQuestionCount(text){var sentences=text.replace(/([.!;])\s+/g,'$1|').split('|').filter(function(s){return s.trim().length>15});var facts=text.match(/\b(is|are|was|were|means|refers to|defined as|consists of|contains|includes)\b/gi);var definitions=text.match(/[A-Z][a-zA-Z\s]{2,30}[:]\s*[A-Z]/g);var count=Math.max(3,Math.min(25,Math.floor(sentences.length/2)));if(facts&&facts.length>5)count=Math.max(count,Math.min(25,facts.length));if(definitions&&definitions.length>3)count=Math.max(count,definitions.length);return{count:count,label:count+' questions'}}

var mcqQuestions=[],mcqAnswers={},mcqSubmitted=false;
function initMCQ(){mcqQuestions=[];mcqAnswers={};mcqSubmitted=false;renderMCQGenerate();switchTestTab('mcq','generate',document.querySelector('#screen-mcq .test-tab'))}
function switchTestTab(type,tab,el){var screen=document.getElementById('screen-'+type);if(!screen)return;screen.querySelectorAll('.test-tab').forEach(function(t){t.classList.remove('active')});screen.querySelectorAll('.test-section').forEach(function(s){s.classList.remove('active')});var sec=document.getElementById(type+'-'+tab);if(sec)sec.classList.add('active');if(el)el.classList.add('active');else{var tabs=screen.querySelectorAll('.test-tab');var idx=['generate','take','results'].indexOf(tab);if(idx>=0&&tabs[idx])tabs[idx].classList.add('active')}}

function renderMCQGenerate(){document.getElementById('mcq-generate').innerHTML='<div class="ai-gen-box"><h4> Generate MCQ</h4><p>Upload or paste text.</p><div class="upload-area" onclick="document.getElementById(\'mcq-file-input\').click()"><input type="file" id="mcq-file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleTestFile(this.files[0],\'mcq\')"><span class="upload-icon"></span><div class="upload-text">Upload</div></div><div id="mcq-upload-status"></div><textarea class="form-input" id="mcq-text-input" placeholder="Paste notes..." style="min-height:120px;margin:10px 0;"></textarea><button class="btn btn-primary btn-full" onclick="generateMCQTest()"> Generate</button></div><div id="mcq-gen-preview"></div>'}

// FIXED: Better MCQ generation with multiple question sources
function generateMCQTest(){var text=document.getElementById('mcq-text-input').value.trim();if(!text||text.length<30){showToast('Add more text');SFX.error();return}var info=analyzeContentForQuestionCount(text);mcqQuestions=generateMCQFromText(text,info.count);mcqAnswers={};mcqSubmitted=false;if(!mcqQuestions.length){showToast('Could not generate');SFX.error();return}addXP(15);addCookies(1);SFX.success();document.getElementById('mcq-gen-preview').innerHTML='<div style="background:var(--green-soft);border-radius:var(--r-lg);padding:18px;text-align:center;margin-top:14px;"> '+mcqQuestions.length+' questions!<br><button class="btn btn-primary" style="margin-top:10px;" onclick="renderMCQTake();switchTestTab(\'mcq\',\'take\',null)">Take Test</button></div>'}

function generateMCQFromText(text,count){var questions=[],usedKeys=new Set();
// Extract sentences with facts
var sentences=text.replace(/([.!;])\s+/g,'$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>15&&s.length<400&&!s.endsWith('?')});
// Pattern 1: Definition sentences
var definitionPattern=/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{2,50}?)\s+(is|are|was|were|refers to|means|defined as)\s+(.{10,250})$/i;
sentences.forEach(function(s){if(questions.length>=count)return;var m=s.match(definitionPattern);if(m){var key=m[2].trim().toLowerCase();if(!usedKeys.has(key)){usedKeys.add(key);var correct=m[4].trim().replace(/\.$/,'');if(correct.length>100)correct=correct.substring(0,100)+'...';var distractors=generateDistractors(text,correct,3);questions.push({question:'What '+m[3].toLowerCase()+' '+m[2].trim()+'?',options:shuffleArray([{text:correct,correct:true}].concat(distractors.map(function(d){return{text:d,correct:false}}))),explanation:s})}}});
// Pattern 2: Key-value pairs from lines
var lines=text.split('\n').filter(function(l){return l.trim().length>5});
lines.forEach(function(ln){if(questions.length>=count)return;var m=ln.trim().match(/^([A-Za-z][^:;]{2,40}?)\s*[:;]\s*(.{10,200})$/);if(m){var key=m[1].trim().toLowerCase();if(!usedKeys.has(key)){usedKeys.add(key);var correct=m[2].trim().replace(/\.$/,'');if(correct.length>100)correct=correct.substring(0,100)+'...';var distractors=generateDistractors(text,correct,3);questions.push({question:'What is '+m[1].trim()+'?',options:shuffleArray([{text:correct,correct:true}].concat(distractors.map(function(d){return{text:d,correct:false}}))),explanation:ln})}}});
// Pattern 3: Fill-in from sentences if still need more
if(questions.length<count){sentences.forEach(function(s){if(questions.length>=count)return;var words=s.split(/\s+/);if(words.length<8)return;var keyTerms=words.filter(function(w){w=w.replace(/[.,;!?]/g,'');return w.length>5&&w[0]===w[0].toUpperCase()&&!/^(The|And|But|For|With|From|That|This|These|Those|They|Their|There|Then|Than|When|Where|What|Which|While|During|Before|After|Above|Below|Under|Over|Into|Onto|Upon|Within|Without|Through|Throughout|Across|Around|Among|Between|During|Before|After)\b/i.test(w)});if(keyTerms.length>0){var term=keyTerms[Math.floor(Math.random()*keyTerms.length)].replace(/[.,;!?]/g,'');var key=term.toLowerCase();if(!usedKeys.has(key)){usedKeys.add(key);var correct=term;var sentenceWithout=s.replace(new RegExp('\\b'+term+'\\b','i'),'_____');var distractors=generateDistractors(text,term,3);questions.push({question:'Fill in the blank: '+sentenceWithout,options:shuffleArray([{text:correct,correct:true}].concat(distractors.map(function(d){return{text:d,correct:false}}))),explanation:s})}}})}
return questions.slice(0,count)}

function generateDistractors(text,correct,count){var distractors=[],sentences=text.replace(/([.!;])\s+/g,'$1|').split('|');var allWords=text.match(/\b[A-Za-z]{4,12}\b/g)||[];var uniqueWords=[...new Set(allWords)].filter(function(w){return w.toLowerCase()!==correct.toLowerCase()&&w.length>4});for(var i=0;i<count&&i<uniqueWords.length;i++){var idx=Math.floor(Math.random()*uniqueWords.length);var word=uniqueWords[idx];if(word&&distractors.indexOf(word)<0)distractors.push(word)}while(distractors.length<count){distractors.push('Option '+(distractors.length+1))}return distractors.slice(0,count)}

function shuffleArray(a){var arr=a.slice();for(var i=arr.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=arr[i];arr[i]=arr[j];arr[j]=t}return arr}

function renderMCQTake(){var el=document.getElementById('mcq-take');if(!mcqQuestions.length){el.innerHTML='<div style="text-align:center;padding:48px;color:var(--text3);">No test yet</div>';return}el.innerHTML=mcqQuestions.map(function(q,i){var ua=mcqAnswers[i];return'<div class="test-q-card"><div class="test-q-num">Q'+(i+1)+'</div><div class="test-q-text">'+esc(q.question)+'</div>'+q.options.map(function(o,oi){var cls='test-opt';if(mcqSubmitted){if(o.correct)cls+=' correct';else if(ua===oi&&!o.correct)cls+=' wrong'}else if(ua===oi)cls+=' selected';return'<div class="'+cls+'" onclick="selectMCQ('+i+','+oi+')"><div class="opt-letter">'+String.fromCharCode(65+oi)+'</div><span>'+esc(o.text)+'</span></div>'}).join('')+'<div class="test-explanation '+(mcqSubmitted?'show':'')+'"> '+esc(q.explanation)+'</div></div>'}).join('')+(mcqSubmitted?'':'<button class="btn btn-primary btn-full" onclick="submitMCQ()">Submit</button>')}

function selectMCQ(qi,oi){if(mcqSubmitted)return;mcqAnswers[qi]=oi;SFX.select();renderMCQTake()}
function submitMCQ(){if(Object.keys(mcqAnswers).length<mcqQuestions.length){showToast('Answer all');SFX.error();return}mcqSubmitted=true;var correct=0;mcqQuestions.forEach(function(q,i){if(mcqAnswers[i]!==undefined&&q.options[mcqAnswers[i]]&&q.options[mcqAnswers[i]].correct)correct++});var pct=Math.round(correct/mcqQuestions.length*100);addXP(20);addCookies(2);logSession('mcq','MCQ',15);save();SFX.success();renderMCQTake();renderMCQResults(correct,pct);switchTestTab('mcq','results',null);saveReviewItem('mcq','MCQ  '+pct+'%','Score: '+correct+'/'+mcqQuestions.length)}
function renderMCQResults(c,p){document.getElementById('mcq-results').innerHTML='<div class="test-score-card"><div class="test-score-big">'+(p||0)+'%</div><div class="test-score-label">'+(c||0)+' correct</div></div><button class="btn btn-primary btn-full" onclick="initMCQ()">New Test</button>'}

var tfQuestions=[],tfAnswers={},tfSubmitted=false;
function initTF(){tfQuestions=[];tfAnswers={};tfSubmitted=false;renderTFGenerate();switchTestTab('tf','generate',document.querySelector('#screen-tf .test-tab'))}
function renderTFGenerate(){document.getElementById('tf-generate').innerHTML='<div class="ai-gen-box"><h4> Generate T/F</h4><p>Upload or paste text.</p><div class="upload-area" onclick="document.getElementById(\'tf-file-input\').click()"><input type="file" id="tf-file-input" accept="image/*,.pdf,.txt" style="display:none" onchange="handleTestFile(this.files[0],\'tf\')"><span class="upload-icon"></span><div class="upload-text">Upload</div></div><div id="tf-upload-status"></div><textarea class="form-input" id="tf-text-input" placeholder="Paste notes..." style="min-height:120px;margin:10px 0;"></textarea><button class="btn btn-primary btn-full" onclick="generateTFTest()"> Generate</button></div><div id="tf-gen-preview"></div>'}

// FIXED: Better T/F generation with multiple patterns
function generateTFTest(){var text=document.getElementById('tf-text-input').value.trim();if(!text||text.length<30){showToast('Add more text');SFX.error();return}var info=analyzeContentForQuestionCount(text);tfQuestions=generateTFFromText(text,info.count);tfAnswers={};tfSubmitted=false;if(!tfQuestions.length){showToast('Could not generate');SFX.error();return}addXP(15);addCookies(1);SFX.success();document.getElementById('tf-gen-preview').innerHTML='<div style="background:var(--green-soft);border-radius:var(--r-lg);padding:18px;text-align:center;margin-top:14px;"> '+tfQuestions.length+' questions!<br><button class="btn btn-primary" style="margin-top:10px;" onclick="renderTFTake();switchTestTab(\'tf\',\'take\',null)">Take Test</button></div>'}

function generateTFFromText(text,count){var questions=[],usedStatements=new Set();
// Extract sentences
var sentences=text.replace(/([.!;])\s+/g,'$1|').split('|').map(function(s){return s.trim()}).filter(function(s){return s.length>20&&s.length<300&&!s.endsWith('?')});
// Pattern 1: Definition-based true statements
var definitionPattern=/^(The\s+|An?\s+)?([A-Z][a-zA-Z\s\-]{2,40}?)\s+(is|are|was|were|has|have|can|will|refers to|means|contains|includes)\s+(.{10,200})$/i;
sentences.forEach(function(s){if(questions.length>=count)return;var m=s.match(definitionPattern);if(m){var statement=m[2].trim()+' '+m[3].toLowerCase()+' '+m[4].trim().replace(/\.$/,'')+'.';if(!usedStatements.has(statement.toLowerCase())){usedStatements.add(statement.toLowerCase());questions.push({statement:statement,answer:true,explanation:'Correct. '+s})}}});
// Pattern 2: Create false statements by modifying true ones
var trueQuestions=questions.filter(function(q){return q.answer});trueQuestions.forEach(function(q){if(questions.length>=count)return;var falseStatement=q.statement.replace(/\bis\b/g,'is not').replace(/\bare\b/g,'are not').replace(/\bwas\b/g,'was not').replace(/\bwere\b/g,'were not').replace(/\bhas\b/g,'does not have').replace(/\bhave\b/g,'do not have').replace(/\bcan\b/g,'cannot').replace(/\bwill\b/g,'will not');if(falseStatement!==q.statement&&!usedStatements.has(falseStatement.toLowerCase())){usedStatements.add(falseStatement.toLowerCase());questions.push({statement:falseStatement,answer:false,explanation:'False. The correct statement is: '+q.statement})}});
// Pattern 3: Key fact statements
if(questions.length<count){sentences.forEach(function(s){if(questions.length>=count)return;var words=s.split(/\s+/);if(words.length<6)return;var keyFacts=s.match(/\b(important|essential|crucial|significant|main|primary|major|key)\b.*\b(is|are|was|were)\b.*\./i);if(keyFacts){var statement=s.replace(/\b(important|essential|crucial|significant|main|primary|major|key)\b/gi,'').trim();if(statement.length>30&&!usedStatements.has(statement.toLowerCase())){usedStatements.add(statement.toLowerCase());if(Math.random()>0.5){questions.push({statement:statement,answer:true,explanation:'Correct. '+s})}else{var negated=statement.replace(/\bis\b/g,'is not').replace(/\bare\b/g,'are not');if(negated!==statement){questions.push({statement:negated,answer:false,explanation:'False. '+s})}}}}})}
// Pattern 4: Generate from list items
if(questions.length<count){var listItems=text.match(/[\-\*]\s*.+/g)||[];listItems.forEach(function(item){if(questions.length>=count)return;var clean=item.replace(/^[\-\*]\s*/,'').trim();if(clean.length>20&&clean.length<200&&!usedStatements.has(clean.toLowerCase())){usedStatements.add(clean.toLowerCase());if(Math.random()>0.3){questions.push({statement:clean,answer:true,explanation:'Correct. This is mentioned in the material.'})}else{var negated=clean.replace(/\bis\b/g,'is not').replace(/\bare\b/g,'are not').replace(/\bwas\b/g,'was not');if(negated!==clean){questions.push({statement:negated,answer:false,explanation:'False. The correct information is: '+clean})}}}})}
return shuffleArray(questions).slice(0,count)}

function renderTFTake(){var el=document.getElementById('tf-take');if(!tfQuestions.length){el.innerHTML='<div style="text-align:center;padding:48px;color:var(--text3);">No test yet</div>';return}el.innerHTML=tfQuestions.map(function(q,i){var ua=tfAnswers[i];return'<div class="test-q-card"><div class="test-q-num">Q'+(i+1)+'</div><div class="test-q-text">'+esc(q.statement)+'</div><div class="tf-btns"><div class="tf-btn '+(tfSubmitted?(q.answer===true?'correct':(ua===true&&!q.answer?'wrong':'')):(ua===true?'selected':''))+'" onclick="selectTF('+i+',true)"> True</div><div class="tf-btn '+(tfSubmitted?(q.answer===false?'correct':(ua===false&&q.answer?'wrong':'')):(ua===false?'selected':''))+'" onclick="selectTF('+i+',false)"> False</div></div><div class="test-explanation '+(tfSubmitted?'show':'')+'"> '+esc(q.explanation)+'</div></div>'}).join('')+(tfSubmitted?'':'<button class="btn btn-primary btn-full" onclick="submitTF()">Submit</button>')}

function selectTF(qi,val){if(tfSubmitted)return;tfAnswers[qi]=val;SFX.select();renderTFTake()}
function submitTF(){if(Object.keys(tfAnswers).length<tfQuestions.length){showToast('Answer all');SFX.error();return}tfSubmitted=true;var correct=0;tfQuestions.forEach(function(q,i){if(tfAnswers[i]===q.answer)correct++});var pct=Math.round(correct/tfQuestions.length*100);addXP(20);addCookies(2);logSession('tf','T/F',10);save();SFX.success();renderTFTake();renderTFResults(correct,pct);switchTestTab('tf','results',null);saveReviewItem('tf','T/F  '+pct+'%','Score: '+correct+'/'+tfQuestions.length)}
function renderTFResults(c,p){document.getElementById('tf-results').innerHTML='<div class="test-score-card"><div class="test-score-big">'+(p||0)+'%</div><div class="test-score-label">'+(c||0)+' correct</div></div><button class="btn btn-primary btn-full" onclick="initTF()">New Test</button>'}

function saveReviewItem(technique,title,content){if(!S.savedReviews)S.savedReviews=[];S.savedReviews.push({id:Date.now(),technique:technique,title:title||'Session',content:content||'',date:new Date().toISOString()});save();showToast(' Saved!')}
function openSavedReviews(){renderSavedReviews();navigateTo('screen-saved','up')}
function renderSavedReviews(){var el=document.getElementById('saved-body');if(!S.savedReviews)S.savedReviews=[];document.getElementById('saved-count').textContent=S.savedReviews.length;if(!S.savedReviews.length){el.innerHTML='<div style="text-align:center;padding:48px 20px;color:var(--text3);">No saved reviews yet!</div>';return}var tm=getTechMap();el.innerHTML=S.savedReviews.slice().reverse().map(function(r,ri){var idx=S.savedReviews.length-1-ri;var t=tm[r.technique];return'<div class="saved-review-card" onclick="SFX.tap();openSavedDetail('+idx+')"><div class="sr-header"><span class="sr-icon">'+(t?t.icon:'')+'</span><span class="sr-title">'+esc(r.title)+'</span><button class="sr-del" onclick="event.stopPropagation();deleteSavedReview('+idx+')"></button></div><div class="sr-meta"><span class="sr-badge" style="background:'+(t?t.soft:'var(--surface2)')+';color:'+(t?t.cval:'var(--text2)')+';">'+(t?t.name:'Other')+'</span><span>'+new Date(r.date).toLocaleDateString()+'</span></div></div>'}).join('')}
function openSavedDetail(idx){if(!S.savedReviews||!S.savedReviews[idx])return;var r=S.savedReviews[idx],tm=getTechMap(),t=tm[r.technique];document.getElementById('saved-detail-title').textContent=r.title||'Detail';document.getElementById('saved-detail-body').innerHTML='<div class="card" style="margin-bottom:14px;"><div style="display:flex;gap:10px;align-items:center;margin-bottom:12px;"><span style="font-size:32px;">'+(t?t.icon:'')+'</span><div><div style="font-size:16px;font-weight:800;">'+esc(r.title)+'</div><div style="font-size:12px;color:var(--text2);">'+new Date(r.date).toLocaleString()+'</div></div></div></div><div class="sr-detail-content">'+esc(r.content||'No content.')+'</div><button class="btn btn-secondary btn-full" onclick="navigateTo(\'screen-saved\',\'down\')"> Back</button>';navigateTo('screen-saved-detail','up')}
function deleteSavedReview(idx){S.savedReviews.splice(idx,1);save();renderSavedReviews();SFX.erase()}

function unlock(key){if(!S.ach)S.ach=[];if(S.ach.indexOf(key)>=0)return;S.ach.push(key);var def=ACHIEVEMENTS_DEF.find(function(a){return a.key===key});if(!def)return;var xm={common:10,rare:25,epic:50,legendary:100};addXP(xm[def.rarity]||10);addCookies(Math.ceil((xm[def.rarity]||10)/10));var nonLeg=ACHIEVEMENTS_DEF.filter(function(a){return a.rarity!=='legendary'}).map(function(a){return a.key});if(nonLeg.every(function(k){return S.ach.indexOf(k)>=0}))setTimeout(function(){unlock('all_ach')},600);save();showAchPop(def.icon,def.name);SFX.unlock()}
function showAchPop(icon,name){document.getElementById('ap-icon').textContent=icon;document.getElementById('ap-name').textContent=name;var p=document.getElementById('ach-popup');p.classList.add('show');burst(window.innerWidth/2,60,['#fbbf24','#f97316','#8b5cf6'],12);setTimeout(function(){p.classList.remove('show')},3500)}
function renderAch(){if(!S.ach)S.ach=[];document.getElementById('ach-count').textContent=S.ach.length+'/'+ACHIEVEMENTS_DEF.length;document.getElementById('ach-grid').innerHTML=ACHIEVEMENTS_DEF.map(function(a){var u=S.ach.indexOf(a.key)>=0;return'<div class="ach-card '+(u?'unlocked':'locked')+'"><span class="ach-icon">'+a.icon+'</span><div class="ach-name">'+a.name+'</div><div class="ach-desc">'+(u?a.desc:'???')+'</div><span class="ach-rarity r-'+a.rarity+'">'+a.rarity+'</span></div>'}).join('')}
function addXP(n){S.xp=(S.xp||0)+n;save()}
var _toastT=null;function showToast(msg){var t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');clearTimeout(_toastT);_toastT=setTimeout(function(){t.classList.remove('show')},2800)}

var CAPY_TIPS=["Try the Feynman Technique  explain it like you're 5! ","Short study bursts beat long marathons! ","Spaced repetition makes memories stick! ","Don't forget to take breaks! ","Drawing diagrams helps you see the big picture! ","Blurting reveals exactly what you've forgotten! ","Teaching someone else is the best way to learn! ","Review before bed  sleep consolidates memory! ","Color-coding notes improves recall by 50%! ","Active recall beats passive rereading! ","Break big topics into smaller chunks! ","Quiz yourself often! ","Drink water! A hydrated brain learns better! ","Mistakes are learning opportunities! ","You're doing amazing  keep going! ","Consistency beats intensity! ","Write questions about what you read! ","Your brain grows stronger with every session! ","Mix up subjects to stay engaged! ","Believe in yourself! "];
var CAPY_HUNGRY_MSGS=["I'm getting hungry... ","My tummy is rumbling... ","A little cookie would be nice... ","Feed me please! ","I need energy for tips! "];
var CAPY_FEED_MSGS=["Yummy cookie! Thank you! ","Nom nom nom! ","That hit the spot! ","So tasty! I love cookies! ","Best cookie ever! "];
var CAPY_PET_MSGS=["Purrrr~ That feels nice! ","Hehe, that tickles! ","I love head scratches! ","*happy capybara noises* ","Best owner ever! ","More pets please! "];
var CAPY_CLICK_MSGS=["*squeak!* ","Hey there! ","Let's study together! ","*wiggles* ","*happy bounce* ","What's up buddy? "];
var CAPY_MOODS={happy:{emoji:'',text:'Happy & content',mouth:'M104 104 Q110 110 116 104'},ecstatic:{emoji:'',text:'Over the moon!',mouth:'M102 103 Q110 112 118 103'},content:{emoji:'',text:'Feeling good',mouth:'M105 105 Q110 108 115 105'},hungry:{emoji:'',text:'Getting hungry...',mouth:'M104 108 Q110 104 116 108'},starving:{emoji:'',text:'Very hungry!',mouth:'M103 110 Q110 103 117 110'},sleepy:{emoji:'',text:'Zzz... resting',mouth:'M106 106 L114 106'}};

function initCapyState(){if(!S.capy){S.capy={name:'Cappy',hunger:80,happiness:80,totalFed:0,lastFed:Date.now(),lastTip:0,lastDecay:Date.now(),petCount:0};save()}}
function getCapyLevel(){var fed=S.capy?S.capy.totalFed:0;if(fed>=100)return{lv:5,title:'Legendary'};if(fed>=50)return{lv:4,title:'Expert'};if(fed>=25)return{lv:3,title:'Growing'};if(fed>=10)return{lv:2,title:'Friendly'};return{lv:1,title:'Baby'}}
function getCapyMood(){if(!S.capy)return CAPY_MOODS.happy;var h=S.capy.hunger,hp=S.capy.happiness;if(h<15)return CAPY_MOODS.starving;if(h<35)return CAPY_MOODS.hungry;if(hp>90&&h>70)return CAPY_MOODS.ecstatic;if(hp>60&&h>50)return CAPY_MOODS.happy;if(h>40)return CAPY_MOODS.content;return CAPY_MOODS.hungry}
function decayCapyStats(){if(!S.capy)return;var now=Date.now(),elapsed=(now-S.capy.lastDecay)/1000/60;if(elapsed<5)return;var decayAmt=Math.floor(elapsed/5)*2;S.capy.hunger=Math.max(0,S.capy.hunger-decayAmt);S.capy.happiness=Math.max(0,S.capy.happiness-Math.floor(decayAmt*0.5));S.capy.lastDecay=now;save()}

function renderCapyWidget(){initCapyState();decayCapyStats();var mood=getCapyMood(),lvInfo=getCapyLevel(),h=S.capy.hunger,hp=S.capy.happiness;var hBar=document.getElementById('capy-hunger-bar'),hpBar=document.getElementById('capy-happy-bar');if(hBar)hBar.style.width=h+'%';if(hpBar)hpBar.style.width=hp+'%';var moodEl=document.getElementById('capy-mood-text');if(moodEl)moodEl.textContent=mood.emoji+' '+mood.text;var lvBadge=document.getElementById('capy-lv-badge');if(lvBadge)lvBadge.textContent='Lv '+lvInfo.lv+' '+lvInfo.title;var nameEl=document.getElementById('capy-pet-name');if(nameEl)nameEl.textContent=S.capy.name;var mouthEl=document.getElementById('capy-mouth');if(mouthEl)mouthEl.setAttribute('d',mood.mouth);var zzzWrap=document.getElementById('capy-zzz-wrap');if(zzzWrap){if(mood===CAPY_MOODS.sleepy)zzzWrap.innerHTML='<div class="capy-zzz" style="position:absolute;top:10px;right:15px;"></div><div class="capy-zzz" style="position:absolute;top:10px;right:5px;animation-delay:0.7s;font-size:11px;"></div>';else zzzWrap.innerHTML=''}var feedBtn=document.getElementById('capy-feed-btn');if(feedBtn){feedBtn.disabled=(S.cookies||0)<1;if(h>=100){feedBtn.innerHTML=' Full!';feedBtn.disabled=true}else feedBtn.innerHTML=' Feed <span class="feed-cost">(1 )</span>'}if(h<25&&Date.now()-(S.capy.lastTip||0)>60000)setTimeout(function(){showCapyBubble(CAPY_HUNGRY_MSGS[Math.floor(Math.random()*CAPY_HUNGRY_MSGS.length)],5000)},2000);if(h>30&&hp>30&&Date.now()-(S.capy.lastTip||0)>120000)setTimeout(function(){showCapyTip()},8000)}

var _capyBubbleTimer=null;
function showCapyBubble(msg,duration){var bubble=document.getElementById('capy-bubble'),textEl=document.getElementById('capy-bubble-text');if(!bubble||!textEl)return;clearTimeout(_capyBubbleTimer);textEl.innerHTML=msg;bubble.classList.add('show');if(S.capy)S.capy.lastTip=Date.now();_capyBubbleTimer=setTimeout(function(){bubble.classList.remove('show')},duration||4000)}
function showCapyTip(){showCapyBubble('<span class="bubble-icon"></span> '+CAPY_TIPS[Math.floor(Math.random()*CAPY_TIPS.length)],6000);if(S.capy)S.capy.lastTip=Date.now();save()}

function feedCapy(){if(!S.capy)initCapyState();if((S.cookies||0)<1){showToast('Need 1 ! Earn by studying.');SFX.error();return}if(S.capy.hunger>=100){showToast('Already full!');SFX.error();return}S.cookies=(S.cookies||0)-1;S.capy.hunger=Math.min(100,S.capy.hunger+25);S.capy.happiness=Math.min(100,S.capy.happiness+10);S.capy.totalFed=(S.capy.totalFed||0)+1;S.capy.lastFed=Date.now();save();var body=document.getElementById('capy-body');if(body){body.classList.remove('capy-eat','capy-bounce','capy-happy','capy-wiggle');void body.offsetWidth;body.classList.add('capy-eat');setTimeout(function(){body.classList.remove('capy-eat')},1000)}flashCapyEyes();showCapyBubble(CAPY_FEED_MSGS[Math.floor(Math.random()*CAPY_FEED_MSGS.length)],3000);SFX.correct();var scene=document.getElementById('capy-scene');if(scene){var r=scene.getBoundingClientRect();burst(r.left+r.width/2,r.top+r.height/2,['#fbbf24','#f97316','#ef4444','#10b981'],8)}renderCapyWidget();renderPetLevelCard();updateCookieDisplay()}

function petCapy(){if(!S.capy)initCapyState();S.capy.happiness=Math.min(100,S.capy.happiness+5);S.capy.petCount=(S.capy.petCount||0)+1;save();var body=document.getElementById('capy-body');if(body){body.classList.remove('capy-eat','capy-bounce','capy-happy','capy-wiggle');void body.offsetWidth;body.classList.add('capy-happy');setTimeout(function(){body.classList.remove('capy-happy')},800)}flashCapyEyes();showCapyBubble(CAPY_PET_MSGS[Math.floor(Math.random()*CAPY_PET_MSGS.length)],3000);SFX.select();spawnCapyHearts(3);renderCapyWidget()}

function onCapyClick(event){if(!S.capy)initCapyState();var body=document.getElementById('capy-body');if(body){body.classList.remove('capy-eat','capy-bounce','capy-happy','capy-wiggle');void body.offsetWidth;var anims=['capy-bounce','capy-wiggle','capy-happy'];body.classList.add(anims[Math.floor(Math.random()*anims.length)]);setTimeout(function(){body.className='capy-svg-wrap'},800)}flashCapyEyes();showCapyBubble(CAPY_CLICK_MSGS[Math.floor(Math.random()*CAPY_CLICK_MSGS.length)],2500);SFX.pop();spawnCapyHearts(1,event)}

function flashCapyEyes(){var closed=document.getElementById('capy-eyes'),open=document.getElementById('capy-eyes-open');if(closed)closed.style.display='none';if(open)open.style.display='';setTimeout(function(){if(closed)closed.style.display='';if(open)open.style.display='none'},1500)}

function spawnCapyHearts(count,event){var scene=document.getElementById('capy-scene');if(!scene)return;var rect=scene.getBoundingClientRect();var emojis=['','','','','',''];for(var i=0;i<count;i++){(function(idx){setTimeout(function(){var h=document.createElement('div');h.className='capy-heart';h.textContent=emojis[Math.floor(Math.random()*emojis.length)];var sx=event?(event.clientX-rect.left):(rect.width/2+Math.random()*40-20);var sy=event?(event.clientY-rect.top):(rect.height/2);h.style.left=sx+'px';h.style.top=sy+'px';h.style.setProperty('--hx',(Math.random()*60-30)+'px');h.style.setProperty('--hr',(Math.random()*40-20)+'deg');scene.appendChild(h);setTimeout(function(){try{h.remove()}catch(e){}},1100)},idx*120)})(i)}}

setInterval(function(){if(S.capy&&curScreen==='screen-home'){decayCapyStats();renderCapyWidget()}},120000);

hideSplash();
</script>
</body>
</html>